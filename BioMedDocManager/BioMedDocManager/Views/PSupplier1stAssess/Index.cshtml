@using BioMedDocManager.Controllers
@using System.Text.Json
@model IEnumerable<Dictionary<string,object>>
@{
    ViewData["Title"] = "電子採購";
    Layout = "_AssetLayout";

    var queryModel = QueryableExtensions.GetSessionQueryModel<SupplierAssessQueryModel>(Context);
    queryModel.OrderBy ??= "supplier_1st_assess_date";

    var headers = ViewData["tableHeaders"] as Dictionary<string, string> ?? new Dictionary<string, string>();

    //暫時用
    var productClasses = (ViewData["PurchaseProductClass"] as List<ProductClass>) ?? new List<ProductClass>();
    var supplierClasses = productClasses.GroupBy(pc => pc.SupplierClass).OrderBy(g => g.Key);

    string LoginUserId = ViewData["LoginUserId"].ToString();
}

<form method="post" id="myForm">
    @Html.AntiForgeryToken()
    <div class="accordion" id="queryAccordion">
        <div class="accordion-item border border-secondary-subtle bg-light">
            <h2 class="accordion-header" id="headingOne">
                <button class="accordion-button collapsed" type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapseOne"
                        aria-expanded="false"
                        aria-controls="collapseOne">
                    <i class="fa fa-search me-2"></i>&ensp;查詢條件
                </button>
            </h2>
            <div id="collapseOne" class="accordion-collapse collapse show"
                 aria-labelledby="headingOne" data-bs-parent="#queryAccordion">
                <div class="accordion-body mx-3">

                    <!-- Row 1：供應商分類 / 品項分類 -->
                    <div class="row mb-3 g-3 row-cols-1 row-cols-md-2 align-items-center">

                        <!-- 組1：供應商分類 -->
                        <div class="col">
                            <div class="row g-2 align-items-center">
                                <label for="supplierClass" class="col-12 col-sm-4 col-form-label text-sm-end text-start">
                                    供應商分類：
                                </label>
                                <div class="col-12 col-sm-8">
                                    <select class="form-select" id="supplierClass" name="@nameof(queryModel.SupplierClass)">
                                        <option value="" selected="@(string.IsNullOrEmpty(queryModel.SupplierClass) ? "selected" : null)">全部</option>
                                        @foreach (var group in supplierClasses)
                                        {
                                            <option value="@group.Key" selected="@(queryModel.SupplierClass == group.Key ? "selected" : null)">
                                                @group.Key
                                            </option>
                                        }
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- 組2：品項分類 -->
                        <div class="col">
                            <div class="row g-2 align-items-center">
                                <label for="productClassDropdown" class="col-12 col-sm-4 col-form-label text-sm-end text-start">
                                    品項分類：
                                </label>
                                <div class="col-12 col-sm-8">
                                    <select class="form-select" id="productClassDropdown" name="@nameof(queryModel.ProductClass)">
                                        <option value="" selected="@(string.IsNullOrEmpty(queryModel.ProductClass) ? "selected" : null)">全部</option>
                                        @foreach (var group in supplierClasses)
                                        {
                                            <optgroup label="@group.Key">
                                                @foreach (var prodClass in group.OrderBy(pc => pc.ProductClassTitle.Contains("停用")).ThenBy(pc => pc.ProductClass1))
                                                {
                                                    var isSelected = queryModel.ProductClass == prodClass.ProductClass1;
                                                    <option value="@prodClass.ProductClass1"
                                                            data-product-class="@prodClass.ProductClass1"
                                                            selected="@(isSelected ? "selected" : null)">
                                                        @prodClass.ProductClass1 @prodClass.ProductClassTitle
                                                    </option>
                                                }
                                            </optgroup>
                                        }
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Row 2：供應商名稱 / 初評狀態 -->
                    <div class="row mb-3 g-3 row-cols-1 row-cols-md-2 align-items-center">

                        <!-- 組1：供應商名稱 -->
                        <div class="col">
                            <div class="row g-2 align-items-center">
                                <label for="supplierName" class="col-12 col-sm-4 col-form-label text-sm-end text-start">
                                    供應商名稱：
                                </label>
                                <div class="col-12 col-sm-8">
                                    @await Html.PartialAsync("_PurchaseSupplierNameDataListSelect", queryModel.SupplierName)
                                </div>
                            </div>
                        </div>

                        <!-- 組2：初評狀態 -->
                        <div class="col">
                            <div class="row g-2 align-items-center">
                                <label for="reviewDateSelect" class="col-12 col-sm-4 col-form-label text-sm-end text-start">
                                    初評狀態：
                                </label>
                                <div class="col-12 col-sm-8">
                                    @{
                                        var reviewOptions = new List<SelectListItem>
                                                                        {
                                                                        new SelectListItem { Value = "", Text = "全部" },
                                                                        new SelectListItem { Value = "已完成評核", Text = "已完成評核" },
                                                                        new SelectListItem { Value = "尚未完成評核", Text = "尚未完成評核" }
                                                                        };
                                    }
                                    <select class="form-select" id="reviewDateSelect" name="@nameof(queryModel.HasReviewDate)">
                                        @foreach (var option in reviewOptions)
                                        {
                                            <option value="@option.Value" selected="@(queryModel.HasReviewDate == option.Value ? "selected" : null)">
                                                @option.Text
                                            </option>
                                        }
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Row 3：風險類型 / （預留） -->
                    <div class="row mb-3 g-3 row-cols-1 row-cols-md-2 align-items-center">

                        <!-- 組1：風險類型 -->
                        <div class="col">
                            <div class="row g-2 align-items-center">
                                <label for="riskLevelSelect" class="col-12 col-sm-4 col-form-label text-sm-end text-start">
                                    風險類型：
                                </label>
                                <div class="col-12 col-sm-8">
                                    <select class="form-select" id="riskLevelSelect" name="@nameof(queryModel.RiskLevel)">
                                        <option value="" selected="@(string.IsNullOrWhiteSpace(queryModel.RiskLevel) ? "selected" : null)">全部</option>
                                        <option value="低" selected="@(queryModel.RiskLevel == "低" ? "selected" : null)">低</option>
                                        <option value="中" selected="@(queryModel.RiskLevel == "中" ? "selected" : null)">中</option>
                                        <option value="高" selected="@(queryModel.RiskLevel == "高" ? "selected" : null)">高</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- 組2：預留（需要時可加欄位） -->
                        <div class="col"></div>
                    </div>

                    <!-- Buttons -->
                    <div class="row mb-3">
                        <div class="d-flex justify-content-center flex-wrap gap-2">
                            <button type="submit" formaction="@Url.Action("Index")" class="btn2 btn-primary search_btn">
                                <i class="fa fa-search"></i>&ensp;查詢
                            </button>
                            <button type="submit" formaction="@Url.Action("GetExcel")" formtarget="_blank" class="btn2 btn-success export_btn">
                                <i class="fa fa-file-export"></i>&ensp;匯出 Excel
                            </button>
                            <button type="button" class="btn2 btn-secondary clear_btn" data-form="myForm">
                                <i class="fa fa-eraser"></i>&ensp;清除
                            </button>
                            <a id="create_btn" href="@Url.Action("Create", "PSupplier1stAssess")" target="_blank" class="btn2 btn-info">
                                <i class="fa fa-plus"></i>&ensp;新增初供評核紀錄
                            </a>
                        </div>
                    </div>




                    <input type="hidden" id="@(nameof(queryModel.OrderBy))" name="@nameof(queryModel.OrderBy)" value="@queryModel.OrderBy" />
                    <input type="hidden" id="@(nameof(queryModel.SortDir))" name="@nameof(queryModel.SortDir)" value="@queryModel.SortDir" />
                    <input type="hidden" id="@nameof(queryModel.PageSize)" name="@nameof(queryModel.PageSize)" value="@queryModel.PageSize" />
                    <input type="hidden" id="@nameof(queryModel.PageNumber)" name="@nameof(queryModel.PageNumber)" value="@queryModel.PageNumber" />

                </div>
            </div>
        </div>
    </div>
</form>

<div class="table">
    <table class="table table-striped table-hover table-bordered text-break" id="myTable">
        <thead>
            <tr>
                @foreach (var item in headers)
                {
                    if (!headers.ContainsKey(item.Key))
                    {
                        continue;
                    }

                    <th data-id="@item.Key">
                        @if (item.Key != "RowNum")
                        {
                            <a href="#" title="點選「@(item.Value)」欄位進行排序"> @item.Value </a>
                        }
                        else
                        {
                            @item.Value
                        }
                        <span class="order-index"> @(queryModel.OrderBy.EndsWith(item.Key) ? (queryModel.SortDir == "asc" ? "▲" : "▼") : "")</span>
                    </th>
                }
                <th class="col-actions">功能</th>
            </tr>
        </thead>
        <tbody>
            @if (!Model.Any())
            {
                <tr>
                    <td colspan="@(headers.Count + 1)">查無資料</td>
                </tr>
            }

            @foreach (var row in Model)
            {
                var keys = row.Keys;
                <tr>
                    @foreach (var key in keys)
                    {
                        if (!headers.ContainsKey(key))
                        {
                            continue;
                        }

                        string value = TableHelper.FormatValue(row[key]);

                        <td class="@(value == "(無)" ? "none-data" : "") @((key == "RowNum") ? "text-nowrap" : "")">
                            @Html.Raw(value)
                        </td>
                    }

                    <td class="col-actions">
                        @{
                            var supplierName = row["supplier_name"]?.ToString();
                            var productClass = row["product_class"]?.ToString();
                            var assess_people = row["assess_people"]?.ToString();
                            var assessDate = row["assess_date"] != null ? ((DateTime)row["assess_date"]).ToString("yyyy-MM-dd") : null;
                        }
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                功能
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <a class="dropdown-item detail"
                                       href="@Url.Action("Details", new { AssessDateString = assessDate, SupplierName = supplierName, ProductClass = productClass })">
                                        檢視
                                    </a>
                                </li>
                                @* 採購評核人 或 是自己初評的，才可以編輯 *@
                                @if (User.IsInRole(BaseController.PurchaseRoleStrings.評核人) || LoginUserId == assess_people)
                                {
                                    <li>
                                        <a class="dropdown-item detail"
                                           href="@Url.Action("Edit", new { AssessDateString = assessDate, SupplierName = supplierName, ProductClass = productClass })">
                                            編輯
                                        </a>
                                    </li>
                                }
                            </ul>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@await Html.PartialAsync("_PagerSection", queryModel)

@section PageScripts {
    <script nonce="@ViewBag.CspNonce">

    </script>
}