@using System
@using System.Linq
@using System.Collections.Generic
@{
    Layout = "_RootLayout";

    // 從 BaseController 的 ViewData 讀必要資訊（供部分初始化腳本用）
    var controllerLabel = ViewData["ControllerLabel"]?.ToString() ?? "";
}

@section Styles {    
    @RenderSection("PageStyles", required: false)
}

@section HeadExtra {
    @RenderSection("PageHeadExtra", required: false)
}

<div class="Main flex-container" id="Main">
    <div id="nav">
        @* === 拆出的 NAV === *@
        @await Html.PartialAsync("_NavBar")

        @* === 拆出的橫向滑動功能列（Banner Menu）=== *@
        @await Html.PartialAsync("_BannerMenu")
    </div>

    <div class="banner">
        @* 麵包屑：共用 partial *@
        @await Html.PartialAsync("_Breadcrumbs")

        @RenderBody()
    </div>

    <div class="banner-footer">
        @await Html.PartialAsync("_Footer")
    </div>

    @* 共用 Modals（你已分拆） *@
    @await Html.PartialAsync("_MessageModals")
</div>

@section Scripts {
    
    @{
        var safeLabel = (controllerLabel ?? "").Replace("查詢", "");
    }

    <script nonce="@ViewBag.CspNonce">
        $(document).ready(function () {
            const $menuButtons = $('#scrollableMenu a.btn');
            $menuButtons.first().addClass('btn-start');
            $menuButtons.last().addClass('btn-end');


            tableSortListener("myForm");// 表格排序事件監聽
            detailModalListener();// 表格的明細按鈕事件監聽
            createModalListener();// 新增按鈕事件監聽
            docTreeModalListener();// 表單樹按鈕事件監聽
            changePasswordModalListener();// 變更密碼按鈕事件監聽
            handlePasteListener();// 表單樹貼上事件監聽
            searchBtnListener("myForm");// 送出查詢事件監聽
            formClearInputListener();// 清除按鈕事件監聽

            const path = window.location.pathname.replace(/\/+$/, ''); // removes trailing slash

            if (!path || path === "/Welcome") {
               // $('#linkSystemSelect').hide();
                $('#scrollableMenu .btn:visible').eq(0).addClass('btn-start');
            }

            // 更新標題
            const title = '@controllerLabel.Replace("查詢", "")';
            updateAccordionLabelFromTitle(title ,'#pageTitle', '.accordion-button');

            // 設定表格樣式
             setTableStyle();

             // tooltip事件監聽
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
              return new bootstrap.Tooltip(tooltipTriggerEl);
            });


            // Modal停用焦點陷阱 + 把焦點移出 modal
            installModalA11yFix(document);

            // 分頁事件監聽
            $(document).on("change","#SelectPageSize",function(){
                updatePageSize();
            });

            $(document).on("click",".page-link",function(){
                let x=$(this).data("x");
                navigatePage(x);
            });

            // 左右捲動按鈕事件監聽
            $(document).on("click", ".scroll-btn.left", function () {
                scrollMenu(-500);
            });

            $(document).on("click", ".scroll-btn.right", function () {
                scrollMenu(500);
            });

            $(document).on("click", ".disabled-link", function () {
                return false;
            });

        });
    </script>

    @* 你已獨立的 TempData 注入 *@
    @await Html.PartialAsync("_TempDataToJs")

    @RenderSection("PageScripts", required: false)
}

@section BodyEnd {
    @RenderSection("PageBodyEnd", required: false)
}