@model CustomerFeedbackSystem.Models.Feedback

@{
    ViewData["Title"] = "我要提問";
    Layout = "_NoNavLayout";
}
<style nonce="@ViewBag.CspNonce">
    .editor-wrapper.is-invalid .tox-tinymce {
        border: 2px solid #dc3545;
        border-radius: 6px;
    }
</style>

<div class="m-4">
    <h4 class="m-3 px-2">
        <i class="bi bi-pencil-square me-2"></i>@ViewData["Title"]
    </h4>

    <form id="feedbackCreateForm"
          method="post"
          asp-action="Create"
          asp-controller="Feedback"
          enctype="multipart/form-data">

        @Html.AntiForgeryToken()

        <!-- Snapshot fields (server-owned, round-trip only) -->
        <input type="hidden" asp-for="SubmittedByRole" />
        <input type="hidden" asp-for="SubmittedByName" />
        <input type="hidden" asp-for="SubmittedByEmail" />
        <input type="hidden" asp-for="SubmittedOrg" />

        <div class="pop">

            <!-- Row 1：主旨 -->
            <div class="row align-items-center my-3">
                <label class="col-md-2 col-form-label text-md-end text-start">
                    <strong>
                        <span class="text-danger">*</span>
                        @Html.DisplayNameFor(m => m.Subject)：
                    </strong>
                </label>
                <div class="col-md-10">
                    <input asp-for="Subject" class="form-control" />
                    <span asp-validation-for="Subject" class="text-danger"></span>
                </div>
            </div>

            <!-- Row 2：提單人（唯讀顯示，與 Edit 一致） -->
            <div class="row align-items-center my-3">
                <label class="col-md-2 col-form-label text-md-end text-start">
                    <strong>@Html.DisplayNameFor(m => m.SubmittedByName)：</strong>
                </label>
                <div class="col-md-4">
                    <div class="form-control-plaintext">
                        @User.FindFirst("FullName")?.Value
                    </div>
                </div>

                <label class="col-md-2 col-form-label text-md-end text-start">
                    <strong>@Html.DisplayNameFor(m => m.SubmittedOrg)：</strong>
                </label>
                <div class="col-md-4">
                    <div class="form-control-plaintext">
                        @("單位待補")
                    </div>
                </div>
            </div>

            <!-- Row 3：緊急程度 / 預期完成日 -->
            <div class="row align-items-center my-3">
                <label class="col-md-2 col-form-label text-md-end text-start">
                    <strong>@Html.DisplayNameFor(m => m.Urgency)：</strong>
                </label>
                <div class="col-md-4">
                    <select asp-for="Urgency" class="form-select">
                        <option value="">-- 請選擇 --</option>
                        <option value="低">低</option>
                        <option value="中">中</option>
                        <option value="高">高</option>
                    </select>
                </div>

                <label class="col-md-2 col-form-label text-md-end text-start">
                    <strong>@Html.DisplayNameFor(m => m.ExpectedFinishDate)：</strong>
                </label>
                <div class="col-md-4">
                    <input class="form-control"
                           type="date"
                           name="ExpectedFinishDate"
                           value="@DateTime.Today.AddDays(14).ToString("yyyy-MM-dd")" />
                </div>
            </div>
            <!-- Row 4：內容 -->
            <div class="row align-items-center my-3">
                <label class="col-md-2 col-form-label text-md-end text-start">
                    <strong>
                        <span class="text-danger">*</span>
                        @Html.DisplayNameFor(m => m.Content)：
                    </strong>
                </label>

                <div class="col-md-10">

                    <!-- client-side alert (TinyMCE only) -->
                    <div id="contentValidationAlert"
                         class="alert alert-warning d-none w-50"
                         role="alert">
                        請先輸入內容，再送出 🙂
                    </div>

                    <!-- editor wrapper -->
                    <div class="editor-wrapper">
                        <textarea asp-for="Content"
                                  id="contentEditor"
                                  rows="5"
                                  class="form-control editor"
                                  placeholder="請輸入提問內容（必填）">
            </textarea>
                    </div>

                    <!-- server-side validation -->
                    <span asp-validation-for="Content" class="text-danger"></span>
                </div>
            </div>
            <!-- 回覆附件 -->
            <div class="row mb-4">
                <label class="col-md-2 col-form-label text-md-end text-start">
                    <strong>附件</strong>
                </label>

                <div class="col-md-10">
                    <div class="border rounded p-3 bg-light">
                        <input type="file"
                               name="attachments"
                               multiple
                               class="form-control" />

                        <small class="text-muted d-block mt-2">
                            可上傳多個檔案（將與本次回覆一起儲存）
                        </small>
                    </div>
                </div>
            </div>


            <!-- Buttons (match Edit visual weight) -->
            <div class="row align-items-center my-4">
                <div class="col-12 d-flex justify-content-center">
                    <button type="submit" formaction="@Url.Action("Create")" formmethod="post"
                            class="btn btn-primary col-6 col-md-3">
                        <i class="fas fa-paper-plane me-1"></i>送出
                    </button>
                </div>
            </div>

        </div>
    </form>
</div>
@section PageScripts {
    <script src="~/js/tinymce/tinymce.min.js"
            nonce="@ViewBag.CspNonce"></script>

    <script nonce="@ViewBag.CspNonce">
        $(function () {

            tinymce.init({
                base_url: '/js/tinymce',
                license_key: 'gpl',
                suffix: '.min',
                selector: '.editor',
                height: 380,
                menubar: false,
                branding: false,
                plugins: ['lists', 'link', 'table', 'code'],
                toolbar:
                    'undo redo | ' +
                    'bold italic underline | ' +
                    'bullist numlist | ' +
                    'link table | ' +
                    'code',
                content_style:
                    'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; font-size: 14px; }',

                setup: function (editor) {

                    // clear invalid state as soon as user types
                    editor.on('input', function () {
                        const text = editor.getContent({ format: 'text' }).trim();
                        if (text) {
                            $('#contentValidationAlert').addClass('d-none');
                            $('.editor-wrapper').removeClass('is-invalid');
                        }
                    });
                }
            });

            $('#feedbackCreateForm').on('submit', function (e) {

                const editor = tinymce.get('contentEditor');
                const plainText = editor.getContent({ format: 'text' }).trim();
                const wrapper = $('.editor-wrapper');

                if (!plainText) {
                    e.preventDefault();

                    $('#contentValidationAlert')
                        .removeClass('d-none')
                        .get(0)
                        .scrollIntoView({ behavior: 'smooth', block: 'center' });

                    wrapper.addClass('is-invalid');
                    editor.focus();
                    return false;
                }

                // clean state
                $('#contentValidationAlert').addClass('d-none');
                wrapper.removeClass('is-invalid');

                tinymce.triggerSave();
            });
        });
    </script>
}
