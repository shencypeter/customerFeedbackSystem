@model CustomerFeedbackSystem.Models.FeedbackDetailsViewModel

@{
    ViewData["Title"] = "回饋單－檢視";
    Layout = "_NoNavLayout";
}


<style nonce="@ViewBag.CspNonce">
    /* TinyMCE validation state */
    .reply-editor-wrapper.is-invalid .tox-tinymce {
        border: 2px solid #dc3545;
        border-radius: 6px;
    }
</style>

<div class="m-4">
    <h4 class="m-3 px-2">
        <i class="bi bi-card-text me-2"></i>@ViewData["Title"]
    </h4>

    <div class="pop">

        <!-- 基本資訊 -->
        <div class="row mb-3 align-items-center">
            <label class="col-md-2 col-form-label text-md-end text-start">
                <strong>@Html.DisplayNameFor(m => m.Feedback.FeedbackNo)：</strong>
            </label>
            <div class="col-md-4">
                <div class="form-control-plaintext">@Model.Feedback.FeedbackNo</div>
            </div>

            <label class="col-md-2 col-form-label text-md-end text-start">
                <strong>@Html.DisplayNameFor(m => m.Feedback.Status)：</strong>
            </label>
            <div class="col-md-4">
                <div class="form-control-plaintext">@Model.Feedback.Status</div>
            </div>
        </div>

        <div class="row mb-3 align-items-center">
            <label class="col-md-2 col-form-label text-md-end text-start">
                <strong>@Html.DisplayNameFor(m => m.Feedback.Subject)：</strong>
            </label>
            <div class="col-md-10">
                <div class="form-control-plaintext">@Model.Feedback.Subject</div>
            </div>
        </div>

        <!-- 提單人 -->
        <div class="row mb-3 align-items-center">
            <label class="col-md-2 col-form-label text-md-end text-start">
                <strong>@Html.DisplayNameFor(m => m.Feedback.SubmittedByName)：</strong>
            </label>
            <div class="col-md-4">
                <div class="form-control-plaintext">@Model.Feedback.SubmittedByName</div>
            </div>

            <label class="col-md-2 col-form-label text-md-end text-start">
                <strong>@Html.DisplayNameFor(m => m.Feedback.SubmittedByRole)：</strong>
            </label>
            <div class="col-md-4">
                <div class="form-control-plaintext">@Model.Feedback.SubmittedByRole)</div>
            </div>
        </div>

        <div class="row mb-3 align-items-center">
            <label class="col-md-2 col-form-label text-md-end text-start">
                <strong>@Html.DisplayNameFor(m => m.Feedback.Urgency)：</strong>
            </label>
            <div class="col-md-4">
                <div class="form-control-plaintext">@Model.Feedback.Urgency</div>
            </div>

            <label class="col-md-2 col-form-label text-md-end text-start">
                <strong>@Html.DisplayNameFor(m => m.Feedback.SubmittedDate)：</strong>
            </label>
            <div class="col-md-4">
                <div class="form-control-plaintext">
                    @Model.Feedback.SubmittedDate.ToString("yyyy-MM-dd")
                </div>
            </div>
        </div>

        <!-- 內容 -->
        <div class="row mb-4 align-items-center">
            <label class="col-md-2 col-form-label text-md-end text-start">
                <strong>@Html.DisplayNameFor(m => m.Feedback.Content)：</strong>
            </label>
            <div class="col-md-10">
                <div class="form-control-plaintext">
                    @Model.Feedback.Content
                </div>
            </div>
        </div>

        <!-- 提問附件 -->
        <div class="row mb-4">
            <label class="col-md-2 col-form-label text-md-end text-start">
                <strong>附件</strong>
            </label>
            <div class="col-md-10">
                @if (Model.QuestionAttachments.Any())
                {
                    <ul class="list-group">
                        @foreach (var file in Model.QuestionAttachments)
                        {
                            <li class="list-group-item py-1">
                                <a href="/Feedback/Attachment/@file.AttachmentId" download> <i class="bi bi-paperclip me-1"></i>@file.FileName</a>
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <div class="text-muted">尚無附件</div>
                }
            </div>
        </div>

        <!-- 回覆紀錄 -->
        <div class="row mb-3">
            <label class="col-md-2 col-form-label text-md-end text-start">
                <strong>回覆紀錄</strong>
            </label>

            <div class="col-md-10">
                @if (Model.Replies.Any())
                {
                    <ul class="list-group">
                        @foreach (var reply in Model.Replies.OrderBy(r => r.CreatedAt))
                        {
                            <li class="list-group-item">
                                <div class="fw-bold">
                                    @reply.ResponderName
                                    <span class="text-muted small ms-2">
                                        @ReplyAt(reply.CreatedAt)
                                    </span>
                                </div>

                                <div class="mt-1">
                                    @Html.Raw(reply.Content)
                                </div>

                                @if (Model.ReplyAttachments.Contains(reply.ResponseId))
                                {
                                    <ul class="list-group mt-2">
                                        @foreach (var file in Model.ReplyAttachments[reply.ResponseId])
                                        {
                                            <li class="list-group-item py-1">
                                                <a href="/Feedback/Attachment/@file.AttachmentId" download> <i class="bi bi-paperclip me-1"></i>@file.FileName</a>
                                            </li>
                                        }
                                    </ul>
                                }
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <div class="text-muted">尚無回覆</div>
                }
            </div>
        </div>

        <hr />

        <!-- 新增回覆 -->
        <form asp-action="Reply"
              asp-controller="Feedback"
              method="post"
              enctype="multipart/form-data"
              id="feedbackReplyForm">

            @Html.AntiForgeryToken()
            <input type="hidden" name="FeedbackId" value="@Model.Feedback.FeedbackId" />

            <div class="row mb-3">
                <label class="col-md-2 col-form-label text-md-end text-start">
                    <strong>新增回覆</strong>
                </label>

         
                <div class="col-md-10">
                    <div id="replyValidationAlert"
                         class="alert alert-warning d-none w-50  text-left d-none"
                         role="alert">
                        請先輸入回覆內容，再送出 🙂
                    </div>
                    

                    <div class="reply-editor-wrapper">
                        <textarea name="Content"
                                  id="replyContent"
                                  class="form-control reply-editor"
                                  rows="5"
                                  placeholder="@User.FindFirst("FullName")?.Value?.Trim() 說: (回覆內容為必填!)">
                        </textarea>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <label class="col-md-2 col-form-label text-md-end text-start">
                    <strong>處理狀態</strong>
                </label>

                <div class="col-md-10">
                    <select class="form-select w-100">
                        <option disabled >新建 (尚未回覆)</option>
                        <option disabled selected=@(Model.Replies.Any()? "selected":null) >處理中 (有新的回覆內容 / 結案後有新增訊息)</option>
                        <option disabled selected=@(Model.Feedback.ClosedDate.HasValue ? "selected" : null)>已結案 (由客戶決定問題是否已解決)</option>
                    </select>
                </div>
            </div>

            <!-- 回覆附件 -->
            <div class="row mb-4">
                <label class="col-md-2 col-form-label text-md-end text-start">
                    <strong>附件</strong>
                </label>

                <div class="col-md-10">
                    <div class="border rounded p-3 bg-light">
                        <input type="file"
                               name="attachments"
                               multiple
                               class="form-control" />

                        <small class="text-muted d-block mt-2">
                            可上傳多個檔案（將與本次回覆一起儲存）
                        </small>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-12 d-flex justify-content-center gap-3">
                    <button type="submit"
                            class="btn btn-primary"
                            formaction="@Url.Action("Reply", new { id = Model.Feedback.FeedbackId })">
                        <i class="fas fa-paper-plane me-1"></i>送出回覆
                    </button>

                    <button type="reset" class="btn btn-secondary">
                        清除
                    </button>
                </div>
            </div>

        </form>

    </div>
</div>



    </div>
</div>

@functions{





    string ReplyAt(DateTime dt)
    {
        var now = DateTime.Now;
        var diff = now - dt;

        if (diff.TotalSeconds < 10)
            return " 剛剛";

        if (diff.TotalSeconds < 60)
            return $" < 1 分鐘前";

        if (diff.TotalMinutes < 60)
            return $" < 1 小時前";

        if (dt.Date == now.Date)
            return "今天稍早";


        return dt.ToString("yyyy/MM/dd HH:mm");
    }


}

@section PageScripts {
    <script src="~/js/tinymce/tinymce.min.js"
            nonce="@ViewBag.CspNonce"></script>

    <script nonce="@ViewBag.CspNonce">
        $(function () {

            tinymce.init({
                base_url: '/js/tinymce',
                license_key: 'gpl',
                suffix: '.min',
                selector: '.reply-editor',
                height: 300,
                menubar: false,
                branding: false,
                plugins: ['lists', 'link', 'table', 'code'],
                toolbar:
                    'undo redo | bold italic underline | ' +
                    'bullist numlist | link table | code',
                content_style:
                    'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; font-size: 14px; }',

                setup: function (editor) {

                    // Clear error as soon as user types (REGISTER ONCE)
                    editor.on('input', function () {
                        const text = editor.getContent({ format: 'text' }).trim();
                        if (text) {
                            $('#replyValidationAlert').addClass('d-none');
                            $('.reply-editor-wrapper').removeClass('is-invalid');
                        }
                    });
                }
            });

            $('#feedbackReplyForm').on('submit', function (e) {

                const editor = tinymce.get('replyContent');
                const plainText = editor.getContent({ format: 'text' }).trim();
                const wrapper = $('.reply-editor-wrapper');

                if (!plainText) {
                    e.preventDefault();

                    $('#replyValidationAlert')
                        .removeClass('d-none')
                        .get(0)
                        .scrollIntoView({ behavior: 'smooth', block: 'center' });

                    wrapper.addClass('is-invalid');
                    editor.focus();
                    return false;
                }

                // Clean state
                $('#replyValidationAlert').addClass('d-none');
                wrapper.removeClass('is-invalid');

                tinymce.triggerSave();
            });
        });
    </script>

}
