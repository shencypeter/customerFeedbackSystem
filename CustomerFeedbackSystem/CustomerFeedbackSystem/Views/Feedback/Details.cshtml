@model CustomerFeedbackSystem.Models.Feedback

@{
    ViewData["Title"] = "回饋單－檢視";
    Layout = "_NoNavLayout";
}

<div class="m-4">
    <h4 class="m-3 px-2">
        <i class="bi bi-card-text me-2"></i>@ViewData["Title"]
    </h4>

    <div class="pop">

        <!-- 基本資訊 -->
        <div class="row mb-3 align-items-center">
            <label class="col-md-2 col-form-label text-md-end text-start">
                <strong>@Html.DisplayNameFor(m => m.FeedbackNo)：</strong>
            </label>
            <div class="col-md-4">
                <div class="form-control-plaintext">@Model.FeedbackNo</div>
            </div>

            <label class="col-md-2 col-form-label text-md-end text-start">
                <strong>@Html.DisplayNameFor(m => m.Status)：</strong>
            </label>
            <div class="col-md-4">
                <div class="form-control-plaintext">@Model.Status</div>
            </div>
        </div>

        <div class="row mb-3 align-items-center">
            <label class="col-md-2 col-form-label text-md-end text-start">
                <strong>@Html.DisplayNameFor(m => m.Subject)：</strong>
            </label>
            <div class="col-md-10">
                <div class="form-control-plaintext">@Model.Subject</div>
            </div>
        </div>

        <!-- 提單人 -->
        <div class="row mb-3 align-items-center">
            <label class="col-md-2 col-form-label text-md-end text-start">
                <strong>@Html.DisplayNameFor(m => m.SubmittedByName)：</strong>
            </label>
            <div class="col-md-4">
                <div class="form-control-plaintext">@Model.SubmittedByName</div>
            </div>

            <label class="col-md-2 col-form-label text-md-end text-start">
                <strong>@Html.DisplayNameFor(m => m.SubmittedOrg)：</strong>
            </label>
            <div class="col-md-4">
                <div class="form-control-plaintext">@Model.SubmittedOrg</div>
            </div>
        </div>

        <div class="row mb-3 align-items-center">
            <label class="col-md-2 col-form-label text-md-end text-start">
                <strong>@Html.DisplayNameFor(m => m.Urgency)：</strong>
            </label>
            <div class="col-md-4">
                <div class="form-control-plaintext">@Model.Urgency</div>
            </div>

            <label class="col-md-2 col-form-label text-md-end text-start">
                <strong>@Html.DisplayNameFor(m => m.SubmittedDate)：</strong>
            </label>
            <div class="col-md-4">
                <div class="form-control-plaintext">
                    @Model.SubmittedDate.ToString("yyyy-MM-dd")
                </div>
            </div>
        </div>

        <!-- 內容 -->
        <div class="row mb-4 align-items-center">
            <label class="col-md-2 col-form-label text-md-end text-start">
                <strong>@Html.DisplayNameFor(m => m.Content)：</strong>
            </label>
            <div class="col-md-10">
                <div class="form-control-plaintext">
                    @Model.Content
                </div>
            </div>
        </div>

        <!-- 附件（顯示區，未實作下載） -->
        <div class="row mb-4">
            <label class="col-md-2 col-form-label text-md-end text-start">
                <strong>附件</strong>
            </label>
            <div class="col-md-10">
                @if (Model.Attachments != null && Model.Attachments.Any())
                {
                    <ul class="list-group">
                        @foreach (var file in Model.Attachments)
                        {
                            <li class="list-group-item d-flex justify-content-between">
                                <span>@file.FileName</span>
                                <span class="text-muted small">
                           
                                </span>
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <div class="text-muted">尚無附件</div>
                }
            </div>
        </div>


        <!-- 回覆紀錄 -->
        <div class="row mb-3">
            <label class="col-md-2 col-form-label text-md-end text-start">
                <strong>回覆紀錄</strong>
            </label>
            <div class="col-md-10">
                @if (Model.Responses != null && Model.Responses.Any())
                {
                    <ul class="list-group">
                        @foreach (var reply in Model.Responses.OrderBy(r => r.CreatedAt))
                        {
                            <li class="list-group-item">
                                <div class="fw-bold">
                       
                                    <span class="text-muted small ms-2">
                                        @reply.CreatedAt.ToString("yyyy-MM-dd HH:mm")
                                    </span>
                                </div>
                                <div class="mt-1">
                                    @reply.Content
                                </div>
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <div class="text-muted">尚無回覆</div>
                }
            </div>
        </div>

        <hr />

        <!-- 新增回覆 -->
        <form asp-action="CreateReply"
              asp-controller="Feedback"
              method="post"
              enctype="multipart/form-data"
              id="feedbackReplyForm">

            @Html.AntiForgeryToken()
            <input type="hidden" name="FeedbackId" value="@Model.FeedbackId" />

            <div class="row mb-3">
                <label class="col-md-2 col-form-label text-md-end text-start">
                    <strong>新增回覆</strong>
                </label>

                <div class="col-md-10">
                    <textarea name="Content"
                              class="form-control reply-editor"
                              rows="5"
                              placeholder="請輸入回覆內容…"></textarea>
                </div>
            </div>

            <!-- 回覆附件 -->
            <div class="row mb-4">
                <label class="col-md-2 col-form-label text-md-end text-start">
                    <strong>附件</strong>
                </label>

                <div class="col-md-10">
                    <div class="border rounded p-3 bg-light">
                        <input type="file"
                               name="Files"
                               multiple
                               class="form-control" />

                        <small class="text-muted d-block mt-2">
                            可上傳多個檔案（將與本次回覆一起儲存）
                        </small>
                    </div>
                </div>
            </div>

            <!-- 操作 -->
            <div class="row mb-4">
                <div class="col-12 d-flex justify-content-center gap-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-1"></i>送出回覆
                    </button>

                    <button type="reset" class="btn btn-secondary">
                        清除
                    </button>
                </div>
            </div>

        </form>


    </div>
</div>

@section PageScripts {
    <script src="~/js/tinymce/tinymce.min.js"
            nonce="@ViewBag.CspNonce"></script>

    <script nonce="@ViewBag.CspNonce">
        $(document).ready(function () {

            tinymce.init({
                base_url: '/js/tinymce',
                license_key: 'gpl',
                suffix: '.min',
                selector: '.reply-editor',
                height: 300,
                menubar: false,
                branding: false,
                plugins: [
                    'lists',
                    'link',
                    'table',
                    'code'
                ],
                toolbar:
                    'undo redo | ' +
                    'bold italic underline | ' +
                    'bullist numlist | ' +
                    'link table | ' +
                    'code',
                content_style:
                    'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; font-size: 14px; }'
            });

            $('#feedbackReplyForm').on('submit', function () {
                tinymce.triggerSave();
            });
        });
    </script>
}
