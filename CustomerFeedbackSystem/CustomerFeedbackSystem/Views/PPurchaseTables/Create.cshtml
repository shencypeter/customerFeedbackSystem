@model CustomerFeedbackSystem.Models.PurchaseRecord
@{
    Layout = "_NoNavWithDetailModalLayout";// 套用無Nav帶有詳細Modal的Layout
    ViewData["Title"] = "請購-新申請";
    var message = TempData["alert_danger"]?.ToString();
}

<div class="m-4">
    <h4 class="m-3 px-2"><i class="bi bi-pencil-square me-2"></i>@ViewData["Title"]</h4>
    <form id="myFormDetail" method="POST" action="@Url.Action("Create")">
        @Html.AntiForgeryToken()
        @if (!string.IsNullOrEmpty(message))
        {
            <div class="alert alert-danger" role="alert">
                @message
            </div>
        }
        <div class="pop">
            <!-- Row：請購日期 / 請購人 -->
            <div class="row align-items-center my-3">
                <label for="@nameof(Model.RequestDate)" class="col-md-2 col-form-label text-md-end text-start">
                    <strong>@Html.DisplayNameFor(m => m.RequestDate)：</strong>
                </label>
                <div class="col-md-4">
                    <input asp-for="RequestDate" class="form-control" type="date" required max="@DateTime.Today.ToString("yyyy-MM-dd")" />
                </div>

                <label for="@nameof(Model.Requester)" class="col-md-2 col-form-label text-md-end text-start">
                    <strong>@Html.DisplayNameFor(m => m.Requester)：</strong>
                </label>
                <div class="col-md-4">
                    @await Html.PartialAsync("_PurchaseRequesterSelect", Model.Requester)
                </div>
            </div>

            <!-- Row：請購編號 / 採購人 -->
            <div class="row align-items-center my-3">
                <label for="@nameof(Model.RequestNo)" class="col-md-2 col-form-label text-md-end text-start">
                    <strong>@Html.DisplayNameFor(m => m.RequestNo)：</strong>
                </label>
                <div class="col-md-4 d-flex align-items-center">
                    <input asp-for="RequestNo" class="form-control" required readonly placeholder="請點選右側「查詢」按鈕" />
                    <a href="@Url.Action("DocSearchModal", "PPurchaseTables")"
                       target="_blank"
                       class="docSearch btn btn-outline-secondary"
                       aria-label="開啟請購編號查詢">
                        <i class="fas fa-search"></i>
                    </a>
                </div>

                <label for="@nameof(Model.Purchaser)" class="col-md-2 col-form-label text-md-end text-start">
                    <strong>@Html.DisplayNameFor(m => m.Purchaser)：</strong>
                </label>
                <div class="col-md-4">
                    @await Html.PartialAsync("_PurchasePurchaserSelect", Model.Purchaser)
                </div>
            </div>

            <!-- Row：品項分類 / 供應商名稱 -->
            <div class="row align-items-center my-3">
                <label for="@nameof(Model.ProductClass)" class="col-md-2 col-form-label text-md-end text-start">
                    <strong>@Html.DisplayNameFor(m => m.ProductClass)：</strong>
                </label>
                <div class="col-md-4">
                    @* 品項分類 *@
                    @await Html.PartialAsync("_PurchaseProductClassSelect", Model.ProductClass)
                </div>

                <label for="@nameof(Model.SupplierName)" class="col-md-2 col-form-label text-md-end text-start">
                    <strong>@Html.DisplayNameFor(m => m.SupplierName)：</strong>
                </label>
                <div class="col-md-4">
                    @* 供應商名稱 *@
                    @await Html.PartialAsync("_PurchaseSupplierNameSelect", Model.SupplierName)
                </div>
            </div>

            <!-- Row：產品名稱（單欄佔滿） -->
            <div class="row align-items-center my-3">
                <label for="@nameof(Model.ProductName)" class="col-md-2 col-form-label text-md-end text-start">
                    <strong>@Html.DisplayNameFor(m => m.ProductName)：</strong>
                </label>
                <div class="col-md-10">
                    <textarea asp-for="ProductName" class="form-control" required rows="2"></textarea>
                </div>
            </div>

            <!-- Row：產品規格（單欄佔滿） -->
            <div class="row align-items-center my-3">
                <label for="@nameof(Model.ProductSpec)" class="col-md-2 col-form-label text-md-end text-start">
                    <strong>@Html.DisplayNameFor(m => m.ProductSpec)：</strong>
                </label>
                <div class="col-md-10">
                    <textarea asp-for="ProductSpec" class="form-control" required rows="4"></textarea>
                </div>
            </div>

            <!-- Row：購買數量 / 產品總價 -->
            <div class="row align-items-center my-3">
                <label for="@nameof(Model.ProductNumber)" class="col-md-2 col-form-label text-md-end text-start">
                    <strong>@Html.DisplayNameFor(m => m.ProductNumber)：</strong>
                </label>
                <div class="col-md-4">
                    <input asp-for="ProductNumber" class="form-control" type="number" min="1" required />
                </div>

                <label for="@nameof(Model.ProductPrice)" class="col-md-2 col-form-label text-md-end text-start">
                    <strong>@Html.DisplayNameFor(m => m.ProductPrice)：</strong>
                </label>
                <div class="col-md-4">
                    <input asp-for="ProductPrice" class="form-control" type="number" min="1" required />
                </div>
            </div>

            <!-- Row：購買單位 / 保存期限 -->
            <div class="row align-items-center my-3">
                <label for="@nameof(Model.ProductUnit)" class="col-md-2 col-form-label text-md-end text-start">
                    <strong>@Html.DisplayNameFor(m => m.ProductUnit)：</strong>
                </label>
                <div class="col-md-4">
                    <input asp-for="ProductUnit" class="form-control" required placeholder="pcs" />
                </div>

                <label for="@nameof(Model.KeepTime)" class="col-md-2 col-form-label text-md-end text-start">
                    <strong>@Html.DisplayNameFor(m => m.KeepTime)：</strong>
                </label>
                <div class="col-md-4">
                    <input asp-for="KeepTime" class="form-control" type="date" />
                </div>
            </div>

            <!-- Row：品質協議 / 品質協議文件 -->
            <div class="row align-items-center my-3">
                <label for="@nameof(Model.QualityAgreement)" class="col-md-2 col-form-label text-md-end text-start">
                    <strong>@Html.DisplayNameFor(m => m.QualityAgreement)：</strong>
                </label>
                <div class="col-md-4">
                    <select class="form-select" id="@nameof(Model.QualityAgreement)" name="@(nameof(Model.QualityAgreement))">
                        <option value="否" selected=@(Model.QualityAgreement == "否" ? "selected" : null)>否</option>
                        <option value="是" selected=@(Model.QualityAgreement == "是" ? "selected" : null)>是</option>
                    </select>
                </div>

                <label for="@nameof(Model.QualityAgreementNo)" class="col-md-2 col-form-label text-md-end text-start">
                    <strong>@Html.DisplayNameFor(m => m.QualityAgreementNo)：</strong>
                </label>
                <div class="col-md-4">
                    <input asp-for="QualityAgreementNo" class="form-control" placeholder="文件號碼" />
                </div>
            </div>

            <!-- Row：變更通知 / 變更通知文件 -->
            <div class="row align-items-center my-3">
                <label for="@nameof(Model.ChangeNotification)" class="col-md-2 col-form-label text-md-end text-start">
                    <strong>@Html.DisplayNameFor(m => m.ChangeNotification)：</strong>
                </label>
                <div class="col-md-4">
                    <select class="form-select" id="@nameof(Model.ChangeNotification)" name="@(nameof(Model.ChangeNotification))">
                        <option value="否" selected=@(Model.ChangeNotification == "否" ? "selected" : null)>否</option>
                        <option value="是" selected=@(Model.ChangeNotification == "是" ? "selected" : null)>是</option>
                    </select>
                </div>

                <label for="@nameof(Model.ChangeNotificationNo)" class="col-md-2 col-form-label text-md-end text-start">
                    <strong>@Html.DisplayNameFor(m => m.ChangeNotificationNo)：</strong>
                </label>
                <div class="col-md-4">
                    <input asp-for="ChangeNotificationNo" class="form-control" placeholder="文件號碼" />
                </div>
            </div>

            <!-- 按鈕列 -->
            <div class="row align-items-center my-3">
                <div class="col-12 d-flex flex-wrap align-items-center justify-content-center">
                    <button type="submit" class="btn2 btn-success mt-2 col-6 col-md-3 mx-1">
                        <i class="fas fa-check-circle"></i> 儲存
                    </button>
                    <button type="button" class="btn2 btn-secondary mt-2 col-6 col-md-3 mx-1 clear_btn" data-form="myFormDetail">
                        <i class="fas fa-eraser"></i>&ensp;清除
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

@section PageScripts {
    <script nonce="@ViewBag.CspNonce">
        // 選擇「品項分類」後，篩選對應「供應商」
        $(document).ready(function () {
            $('#ProductClass').on('change', function () {
                const selectedProductClass = $(this).val();
                filterSuppliersByProductClass(selectedProductClass, '#SupplierName');
            });

            formClearInputListener();              // 清除按鈕事件監聽
            docSearchBtnDetailModalListener();     // 請購編號查詢事件監聽

            // 初始檢查
            toggleRequired("QualityAgreement", "#QualityAgreementNo");
            toggleRequired("ChangeNotification", "#ChangeNotificationNo");

            // 綁定事件
            $("#QualityAgreement").on("change", function () {
                toggleRequired("QualityAgreement", "#QualityAgreementNo");
            });

            $("#ChangeNotification").on("change", function () {
                toggleRequired("ChangeNotification", "#ChangeNotificationNo");
            });
        });
    </script>
}