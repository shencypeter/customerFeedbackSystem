@model BulletinMessage
@using System.Text.Json
@{
    Layout = "_AssetLayout";

    var queryModel = QueryableExtensions.GetSessionQueryModel<AccountModel>(Context);

    var headers = ViewData["tableHeaders"] as Dictionary<string, string> ?? new Dictionary<string, string>();

    var alert = ViewData["Message"] as string;
}

<form method="post" id="myForm" action="@Url.Action("SetMessage")">
    @Html.AntiForgeryToken()
    <div class="accordion" id="accordionExample">
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingMessage">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseMessage" aria-expanded="false" aria-controls="collapseMessage">
                    <i class="fa fa-bullhorn"></i>&ensp;訊息設定
                </button>
            </h2>
            <div id="collapseMessage" class="accordion-collapse collapse show" aria-labelledby="headingMessage"
                 data-bs-parent="#accordionExample">
                <div class="accordion-body mx-3">
                    <!-- 全部單欄：左 2（label）、右 10（欄位） -->
                    <!-- 1-1. 關閉文件訊息內容 -->
                    <div class="row mb-3 align-items-start">
                        <label for="BulletinContent" class="col-12 col-md-3 col-form-label text-md-end text-start">
                            <span class="text-danger fw-bold">*</span>1-1. 關閉文件訊息內容：
                        </label>
                        <div class="col-12 col-md-9">
                            <textarea class="form-control"
                                      id="BulletinContent"
                                      name="@nameof(Model.BulletinContent)"
                                      rows="2"
                                      placeholder="跑馬燈訊息....."
                                      required>@Html.Raw(Model.BulletinContent)</textarea>
                        </div>
                    </div>

                    <!-- 1-2. 關閉文件領用日期 -->
                    @{
                        var sampleDate = Model.DocTurnoffDate.GetValueOrDefault(DateTime.Today);
                    }
                    <div class="row mb-3 align-items-start">
                        <label for="inDatetime" class="col-12 col-md-3 col-form-label text-md-end text-start">
                            <span class="text-danger fw-bold">*</span>1-2. 關閉文件領用日期：
                        </label>
                        <div class="col-12 col-md-9">
                            <input type="date" class="form-control"
                                   id="inDatetime"
                                   name="@nameof(Model.DocTurnoffDate)"
                                   value="@(Model.DocTurnoffDate?.ToString("yyyy-MM-dd") ?? "")"
                                   required />
                            <div class="form-text text-start">
                                ※ 若設為 @($"{sampleDate:yyyy/MM/dd}，只能領用 {sampleDate.AddDays(1):yyyy/MM/dd} 之後的文件號")
                            </div>
                        </div>
                    </div>

                    <!-- 2. 表單儲存路徑 -->
                    <div class="row mb-3 align-items-start">
                        <label for="FormPath" class="col-12 col-md-3 col-form-label text-md-end text-start">
                            <span class="text-danger fw-bold">*</span>2. 表單儲存路徑：
                        </label>
                        <div class="col-12 col-md-9">
                            <input type="text" class="form-control"
                                   id="FormPath"
                                   name="@nameof(Model.FormPath)"
                                   value="@Model.FormPath"
                                   required />
                        </div>
                    </div>

                    <!-- 3. 登入公告 -->
                    <div class="row mb-3 align-items-start">
                        <label for="LoginMessage" class="col-12 col-md-3 col-form-label text-md-end text-start">
                            3. 登入公告：
                        </label>
                        <div class="col-12 col-md-9">
                            <!-- 注意 placeholder 行首不可縮排，避免空白被呈現 -->
                            <textarea class="form-control"
                                      id="LoginMessage"
                                      name="@nameof(Model.LoginMessage)"
                                      rows="6"
                                      placeholder="(非必填)跑馬燈文字輸入區，範例：
訊息1
訊息2
訊息3">@Html.Raw(Model.LoginMessage)</textarea>
                            <div class="form-text text-start">
                                ※ 請使用「換行符號」分隔多筆訊息，系統將於登入畫面逐條呈現 <i class="fas fa-bullhorn text-danger"></i> 跑馬燈輪播訊息。
                            </div>
                        </div>
                    </div>


                    @* 2025/8/5：因不用將表單掃描上傳回系統中存檔，所以把管理設定的「文件儲存路徑」隱藏 *@
                    @*
                    <div class="row mb-3">
                        <div class="col-md-9 col-form-label">
                            <label for="@nameof(Model.DocPath)" class="form-label mb-0"><span class="text-danger fw-bold">*</span>3. 文件儲存路徑：</label>
                        </div>
                        <div class="col-md-9">
                            <input type="text" class="form-control"
                                   id="@nameof(Model.DocPath)"
                                   name="@nameof(Model.DocPath)"
                                   value="@Model.DocPath"
                                   required />
                        </div>
                    </div>
                    *@

                    <!-- Buttons -->
                    <div class="row mt-3">
                        <div class="col-12 d-flex flex-wrap justify-content-center gap-2">
                            <button type="submit" class="btn2 btn-success mt-2 col-12 col-md-auto">
                                <i class="fas fa-check-circle"></i>&ensp;儲存
                            </button>

                            @*
                            考量效益不大，先隱藏
                            <a href="/CDocumentClaim/Index" id="demo_btn" class="btn2 btn-primary mt-2 col-12 col-md-auto">
                                <i class="fas fa-eye"></i>&ensp;預覽訊息
                            </a>
                            *@

                            <button type="button" class="btn2 btn-info mt-2 col-12 col-md-auto"
                                    data-bs-toggle="modal" data-bs-target="#adminSettingsModal">
                                <i class="fas fa-info-circle"></i>&ensp;管理者設定說明
                            </button>
                        </div>
                    </div>


                </div>
            </div>
        </div>
    </div>
</form>

<!-- Modal 結構 -->
<div class="modal fade" id="adminSettingsModal" tabindex="-1" aria-labelledby="adminSettingsModalLabel">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="adminSettingsModalLabel">管理者設定說明</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉視窗"></button>
            </div>
            <div class="modal-body">
                <ul>
                    <li>
                        <strong>1-1. 關閉文件訊息內容</strong>
                        <ul>
                            <li>請填寫「關閉文件」的說明內容。</li>
                            <li>系統於「文件領用」頁面中顯示對應提示文字。</li>
                        </ul>
                    </li>
                    <li>
                        <strong>1-2. 設定關閉文件領用日期</strong>
                        <ul>
                            <li>請填寫文件關閉領用的最終「領用日期」。</li>
                            <li>系統於「文件領用」頁面限制，不得領用該日之前的所有表單。</li>
                            <li>若需領用文件關閉前的表單，請透過文管負責人，以「保留號領用」協助辦理，或將「關閉文件領用日期」設定為較舊的日期，以重新開放領用功能。</li>
                        </ul>
                    </li>
                    <li>
                        <strong>2. 表單儲存路徑</strong>
                        <ul>
                            <li>請填寫「表單儲存路徑」的資料夾路徑。</li>
                            <li>系統於各頁面之「表單下載」功能將透過該設定值進行檔案下載，請務必確認表單路徑正確。</li>
                        </ul>
                    </li>
                    <li>
                        <strong>3. 登入公告</strong>
                        <ul>
                            <li>請填寫系統的「公告訊息內容」。</li>
                            <li>系統於「登入」頁面中顯示公告內容。</li>
                        </ul>
                    </li>

                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-dark" data-bs-dismiss="modal"><i class="fas fa-times"></i> 關閉視窗</button>
            </div>
        </div>
    </div>
</div>

@if (TempData["Message"] != null)
{
    <div class="alert alert-success mt-4">
        <i class="fas fa-check-circle"></i> @TempData["Message"]
    </div>
}

@section PageScripts {
    <script nonce="@ViewBag.CspNonce">

        // Handle clicks on elements with the `#demo_btn` class
        $(document).on("click", "#demo_btn", function(event) {
            // console.log("demo_btn");
            event.preventDefault(); // Prevent default behavior

            var originUrl = $(this).attr("href"); // Get the href of the clicked link
            var BulletinContent=document.getElementById("BulletinContent");
            var inDatetime=document.getElementById("inDatetime");

            // 自訂參數
            var extraParams = {
                type: "demo",
                key: "vbuWad_Gyr5j25f",
                BulletinContent:BulletinContent.value,
                inDatetime:inDatetime.value
            };

            // 分析 URL 並加上參數
            var url = new URL(originUrl, window.location.origin);
            for (const [k, v] of Object.entries(extraParams)) {
                url.searchParams.set(k, v); // 加上或取代參數
            }

            if (!url) {
                alert("No URL specified.");
                return;
            }

            // Set the iframe source to the detail page
                $("#modalIframe") .attr("src", url);

            // Show the modal
            openModal();

            $("#modalIframe").css("pointer-events", "none");
        });
    </script>
}