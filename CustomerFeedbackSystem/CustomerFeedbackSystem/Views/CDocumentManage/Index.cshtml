@using System.Text.Json
@model List<Dictionary<string, object>>
@{
    ViewData["Title"] = "文件管制";
    Layout = "_AssetLayout";

    var queryModel = QueryableExtensions.GetSessionQueryModel<FormQueryModel>(Context);
    queryModel.OrderBy ??= "date_time";
    queryModel.SortDir ??= "asc";

    var UserName = User.FindFirst("Name")?.Value;
    queryModel.Id = queryModel.Id ?? UserName;
}

<form method="post" id="myForm">
    @Html.AntiForgeryToken()
    <div class="accordion" id="accordionForm">
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingForm">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseForm" aria-expanded="false" aria-controls="collapseForm">
                    <i class="fas fa-clipboard-list"></i>&ensp;查詢條件
                </button>
            </h2>
            <div id="collapseForm" class="accordion-collapse collapse show" aria-labelledby="headingForm"
                 data-bs-parent="#accordionForm">
                <div class="accordion-body mx-3">

                    <!-- Row 1：文件類別 / 文件狀態 -->
                    <div class="row mb-3 g-3 row-cols-1 row-cols-md-2 align-items-center">

                        <!-- 組1：文件類別 -->
                        <div class="col">
                            <div class="row g-2 align-items-center">
                                <label class="col-12 col-sm-4 col-form-label text-sm-end text-start">
                                    文件類別：
                                </label>
                                <div class="col-12 col-sm-8">
                                    @{
                                        var docTypes = new List<(string Value, string Label)>
                                                                        {
                                                                        ("B", "廠內文件"),
                                                                        ("E", "外來文件"),
                                                                        ("",  "全部")
                                                                        };
                                    }
                                    @foreach (var docType in docTypes)
                                    {
                                        var rbId = string.IsNullOrEmpty(docType.Value) ? "docType_all" : $"docType_{docType.Value}";
                                        bool isChecked = string.IsNullOrEmpty(queryModel.DocType)
                                        ? string.IsNullOrEmpty(docType.Value)
                                        : queryModel.DocType == docType.Value;
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input"
                                                   type="radio"
                                                   name="@nameof(FormQueryModel.DocType)"
                                                   id="@rbId"
                                                   value="@docType.Value"
                                                   @(isChecked ? "checked" : "") />
                                            <label class="form-check-label" for="@rbId">@docType.Label</label>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- 組2：文件狀態 -->
                        <div class="col">
                            <div class="row g-2 align-items-center">
                                <label class="col-12 col-sm-4 col-form-label text-sm-end text-start">
                                    文件狀態：
                                </label>
                                <div class="col-12 col-sm-8">
                                    <div class="form-check form-check-inline">
                                        <input type="radio" class="form-check-input"
                                               id="statusFiled"
                                               name="@nameof(queryModel.FiledOrRevoked)"
                                               value="filed"
                                               @(queryModel.FiledOrRevoked == "filed" ? "checked" : null) />
                                        <label class="form-check-label" for="statusFiled">已入庫或已註銷</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input type="radio" class="form-check-input"
                                               id="statusUnfiled"
                                               name="@nameof(queryModel.FiledOrRevoked)"
                                               value="unfiled"
                                               @(queryModel.FiledOrRevoked == "unfiled" ? "checked" : null) />
                                        <label class="form-check-label" for="statusUnfiled">未入庫及未註銷</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input type="radio" class="form-check-input"
                                               id="statusAny"
                                               name="@nameof(queryModel.FiledOrRevoked)"
                                               value=""
                                               @((string.IsNullOrEmpty(queryModel.FiledOrRevoked)) ? "checked" : null) />
                                        <label class="form-check-label" for="statusAny">全部</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Row 2：領用人 / 追蹤日期 -->
                    <div class="row mb-3 g-3 row-cols-1 row-cols-md-2 align-items-center">

                        <!-- 組1：領用人 -->
                        <div class="col">
                            <div class="row g-2 align-items-center">
                                <label class="col-12 col-sm-4 col-form-label text-sm-end text-start" for="@(nameof(queryModel.Id))">
                                    領用人：
                                </label>
                                <div class="col-12 col-sm-8">
                                    @await Html.PartialAsync("_DocUserSelect", queryModel.Id)
                                </div>
                            </div>
                        </div>

                        <!-- 組2：追蹤日期 -->
                        <div class="col">
                            <div class="row g-2 align-items-center">
                                <label for="InTime1" class="col-12 col-sm-4 col-form-label text-sm-end text-start" for="@nameof(queryModel.InTime1)">
                                    追蹤日期：
                                </label>

                                <div class="col-12 col-sm-8">
                                    <div class="row g-2 align-items-center">
                                        <!-- 起 -->
                                        <div class="col-12 col-lg-6">
                                            <div class="input-group">
                                                <input type="date"
                                                       class="form-control"
                                                       id="@nameof(queryModel.InTime1)"
                                                       name="@nameof(queryModel.InTime1)"
                                                       value="@(queryModel.InTime1?.ToString("yyyy-MM-dd"))"
                                                       max='@DateTime.Today.ToString("yyyy-MM-dd")' />
                                                <label class="input-group-text py-1" for="@nameof(queryModel.InTime1)">起</label>
                                            </div>
                                        </div>
                                        <!-- 止 -->
                                        <div class="col-12 col-lg-6">
                                            <div class="input-group">
                                                <input type="date"
                                                       class="form-control"
                                                       id="@nameof(queryModel.InTime2)"
                                                       name="@nameof(queryModel.InTime2)"
                                                       value="@(queryModel.InTime2?.ToString("yyyy-MM-dd"))"
                                                       max='@DateTime.Today.ToString("yyyy-MM-dd")' />
                                                <label class="input-group-text py-1" for="@nameof(queryModel.InTime2)">止</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Row 3：表單編號 / 文件編號 -->
                    <div class="row mb-3 g-3 row-cols-1 row-cols-md-2 align-items-center">

                        <!-- 組1：表單編號 -->
                        <div class="col">
                            <div class="row g-2 align-items-center">
                                <label class="col-12 col-sm-4 col-form-label text-sm-end text-start" for="txt_form_no">
                                    表單編號：
                                </label>
                                <div class="col-12 col-sm-8">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="txt_form_no"
                                               name="@nameof(FormQueryModel.FormNo)"
                                               value="@queryModel.FormNo"
                                               placeholder="輸入表單編號" />
                                        <a class="btn btn-sm btn-secondary doc_tree_search_btn"
                                           target="_blank"
                                           href='@Url.Action("SearchAll", "Tree")'>
                                            <i class="fas fa-project-diagram"></i>&ensp;查詢
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 組2：文件編號 -->
                        <div class="col">
                            <div class="row g-2 align-items-center">
                                <label class="col-12 col-sm-4 col-form-label text-sm-end text-start" for="fileNumber">
                                    文件編號：
                                </label>
                                <div class="col-12 col-sm-8">
                                    <input type="text" class="form-control" id="fileNumber"
                                           name="@nameof(FormQueryModel.DocNo)"
                                           value="@queryModel.DocNo"
                                           placeholder="輸入文件編號" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Row 4：是否機密 / 是否機敏 -->
                    <div class="row mb-3 g-3 row-cols-1 row-cols-md-2 align-items-center">

                        <!-- 組1：是否機密 -->
                        <div class="col">
                            <div class="row g-2 align-items-center">
                                <label for="IsConfidential"
                                       class="col-12 col-sm-4 col-form-label text-sm-end text-start"
                                       data-bs-toggle="tooltip"
                                       data-bs-placement="top"
                                       data-bs-html="true"
                                       data-bs-custom-class="tooltip-left"
                                       title="<b>機密（Confidential）文件：</b>合約管理與客戶服務作業紀錄、製程、檢驗、設計、稽核、風險評估等相關三階工作指導書及四階品質紀錄文件(包含BMP-QP01程序書6.1.3內容所述方式之檔案)皆列為機密。">
                                    是否機密：
                                </label>
                                <div class="col-12 col-sm-8">
                                    @await Html.PartialAsync("_DocumentClaimConfidentialSelect", queryModel.IsConfidential)
                                </div>
                            </div>
                        </div>

                        <!-- 組2：是否機敏 -->
                        <div class="col">
                            <div class="row g-2 align-items-center">
                                <label for="IsSensitive"
                                       class="col-12 col-sm-4 col-form-label text-sm-end text-start"
                                       data-bs-toggle="tooltip"
                                       data-bs-placement="top"
                                       data-bs-html="true"
                                       data-bs-custom-class="tooltip-left"
                                       title="<b>機敏（Sensitive）文件：</b>根據醫療器材品質管理系統準則第13條與個人資料保護法第6條，機敏健康資訊指與個人健康相關，需受特殊保護的資訊，包括但不限於「病歷、醫療、基因、性生活、健康檢查及犯罪前科」之個人資料。">
                                    是否機敏：
                                </label>
                                <div class="col-12 col-sm-8">
                                    @await Html.PartialAsync("_DocumentClaimSensitiveSelect", queryModel.IsSensitive)
                                </div>
                            </div>
                        </div>
                    </div>




                    <!-- Hidden fields -->
                    <input type="hidden" id="@(nameof(queryModel.OrderBy))" name="@nameof(queryModel.OrderBy)" value="@queryModel.OrderBy" />
                    <input type="hidden" id="@(nameof(queryModel.SortDir))" name="@nameof(queryModel.SortDir)" value="@queryModel.SortDir" />
                    <input type="hidden" id="@nameof(queryModel.PageSize)" name="@nameof(queryModel.PageSize)" value="@queryModel.PageSize" />
                    <input type="hidden" id="@nameof(queryModel.PageNumber)" name="@nameof(queryModel.PageNumber)" value="@queryModel.PageNumber" />


                    <!-- Buttons -->
                    <div class="row mt-4">
                        <div class="col-12 d-flex justify-content-center flex-wrap gap-2">

                            <button type="submit" formaction="@Url.Action("Index")"
                                    class="btn2 btn-primary mt-2 search_btn">
                                <i class="fas fa-search"></i> 查詢
                            </button>

                            <button type="submit" formaction="@Url.Action("GetExcel")"
                                    formtarget="_blank"
                                    class="btn2 btn-success mt-2 export_btn">
                                <i class="bi bi-file-earmark-excel-fill"></i> 匯出 Excel
                            </button>

                            <button type="submit" formaction="@Url.Action("GetWord")"
                                    formtarget="_blank"
                                    class="btn2 btn-info mt-2 export_btn">
                                <i class="bi bi-file-earmark-word-fill"></i> 匯出 Word
                            </button>

                            <button type="button" class="btn2 btn-secondary mt-2 clear_btn"
                                    data-form="myForm">
                                <i class="fas fa-eraser"></i> 清除
                            </button>

                        </div>
                    </div>


                </div>
            </div>
        </div>
    </div>
</form>

@{
    var headers = ViewData["tableHeaders"] as Dictionary<string, string> ?? new Dictionary<string, string>();
}

<div class="table">
    <table class="table table-striped table-hover table-bordered text-break" id="myTable">
        <thead>
             <tr>
                @foreach (var item in headers)
                {
                    <th data-id="@item.Key">
                        @if (item.Key != "RowNum")
                        {
                            <a href="#" title="點選「@(item.Value)」欄位進行排序"> @item.Value </a>
                        }
                        else
                        {
                            @Html.Raw(item.Value)
                        }
                        <span class="order-index"> @(queryModel.OrderBy.EndsWith(item.Key) ? (queryModel.SortDir == "asc" ? "▲" : "▼") : "")</span>
                    </th>
                }

                <th class="col-actions">功能</th>
            </tr>
        </thead>
        <tbody>
            @if (!Model.Any())
            {
                <tr>
                    <td colspan="@(headers.Count + 1)">查無資料</td>
                </tr>
            }

            @foreach (var row in Model)
            {
                var keys = row.Keys;
                <tr>
                    @foreach (var key in keys)
                    {
                        if (!headers.ContainsKey(key))
                        {
                            continue;
                        }

                        string value = TableHelper.FormatValue(row[key]);

                        <td class="@(value == "(無)" ? "none-data" : "") @((key == "RowNum") ? "text-nowrap" : "")">
                            @Html.Raw(value)
                        </td>
                    }
                    <td class="col-actions">
                        @{
                            var id_no = row["id_no"];
                        }
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                功能
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item detail" href="@Url.Action("Edit", "CDocumentManage", new { IdNo = id_no })">編輯文件</a></li>
                                @if (row["unuse_time"] == null)
                                {
                                    //入庫：正常文件才可入庫，已註銷文件就不須入庫
                                    <li><a class="dropdown-item detail" href="@Url.Action("StockIn", "CDocumentManage", new { IdNo = id_no })">@(row["in_time"] == null ? "" : "編輯")入庫</a></li>
                                }
                                @if (row["in_time"] == null)
                                {
                                    //註銷：正常文件可以選擇要不要註銷，若已入庫則不可顯示註銷
                                    <li><a class="dropdown-item detail" href="@Url.Action("Cancel", "CDocumentManage", new { IdNo = id_no })">@(row["unuse_time"] == null ? "" : "編輯")註銷</a></li>
                                }
                            </ul>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@await Html.PartialAsync("_PagerSection", queryModel)

@section PageScripts {

    <script nonce="@ViewBag.CspNonce">

    </script>
}