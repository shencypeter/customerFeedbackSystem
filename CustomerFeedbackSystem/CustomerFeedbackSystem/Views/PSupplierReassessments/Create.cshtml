@model IEnumerable<Dictionary<string,object>>
@{
    ViewData["Title"] = "再評估-產生新的再評核記錄";
    Layout = "_NoNavLayout";

    var queryModel = QueryableExtensions.GetSessionQueryModel<SupplierAssessQueryModel>(Context);

    //assign default if null
    queryModel.OrderBy = queryModel.OrderBy ?? "assess_result desc,avg_grade desc,supplier_name COLLATE Chinese_Taiwan_Stroke_CI_AS";

    var headers = ViewData["tableHeaders"] as Dictionary<string, string> ?? new Dictionary<string, string>();

}

<div class="m-4">
    <h4 class="m-3 px-2"><i class="bi bi-pencil-square me-2"></i>@ViewData["Title"]</h4>
    <form id="myFormDetail" method="POST" action="@Url.Action("Insert")">
        @Html.AntiForgeryToken()
        <div class="pop">
            <div class="row align-items-center my-3">
                <!-- 請購日期 -->
                <label for="RequestDate" class="col-md-2 col-form-label text-md-end text-start"><strong>請購日期(起)：</strong></label>
                <div class="col-md-4">
                    <input type="text" name="@(nameof(queryModel.AssessDateStart))" readonly class="form-control-plaintext" value="@queryModel.AssessDateStart?.ToString("yyyy-MM-dd")" />
                </div>
                <label for="RequestDate" class="col-md-2 col-form-label text-md-end text-start"><strong>請購日期(迄)：</strong></label>
                <div class="col-md-4">
                    <input type="text" name="@(nameof(queryModel.AssessDateEnd))" readonly class="form-control-plaintext" value="@queryModel.AssessDateEnd?.ToString("yyyy-MM-dd")" />
                </div>
            </div>
            <div class="row align-items-center my-3">
                <label for="NewAssessDate" class="col-md-2 form-label mb-0"><strong>新評核日期：</strong></label>
                <div class="col-md-10">
                    <input type="date" class="form-control" id="@(nameof(queryModel.NewAssessDate))" name="@(nameof(queryModel.NewAssessDate))" value="@queryModel.NewAssessDate?.ToString("yyyy-MM-dd")" required max="@DateTime.Today.ToString("yyyy-MM-dd")" />
                </div>
            </div>
            <div class="row align-items-center my-3">
                <label class="col-md-2 form-label mb-0"><strong>說明：</strong></label>
                <div class="col-md-10">
                    <ul>
                        @*需對照文本修正*@
                        <li>每一年進行乙次合格供應商再評估作業，以下列出統計期間所有「供應商評核表(BMP-QP21-TR003)」之分數統計分析結果。</li>
                        <li>
                            初次供應商評核結果為：
                            <ul>
                                <li>
                                    <span class="badge bg-danger fw-bold">高風險</span> 品項類別者：
                                    平均分數需達 <span class="text-primary fw-bold">90分</span> 以上為合格。
                                </li>
                                <li>
                                    <span class="badge bg-warning text-dark fw-bold">中風險</span> 品項類別者：
                                    平均分數需達 <span class="text-primary fw-bold">80分</span> 以上為合格。
                                </li>
                                <li>
                                    <span class="badge bg-success fw-bold">低風險</span> 品項類別者：
                                    平均分數需達 <span class="text-primary fw-bold">70分</span> 以上為合格。
                                </li>
                            </ul>
                        </li>
                        <li>
                            若評核結果低於其分類標準者，移出「合格供應商清冊(BMP-QP21-TR001」並列入「不合格供應商清冊(BMP-QP21-TR004)」中並記錄不合格原因說明與評核日期。
                        </li>
                        <li>
                            完成當年度再評估的合格供應商於「合格供應商清冊(BMP-QP21-TR001)」通過日期則為該年度再評估完成之日期。當年度沒有進行再評估供應商，則保留原通過日。
                        </li>
                        <li>
                            供應商於評估期間連續三年度未有「供應商評核」或「再評估」紀錄者，則由「合格供應商清冊(BMP-QP21-TR001)」中移除。若需再跟此供應商進行交易作業，則依「初評與風險評估」流程重新進行。
                        </li>
                        <li>
                            (待確認)未於初次供應商評核填寫「風險類型」之舊資料，合格分數以70分計算。
                        </li>
                    </ul>
                </div>
            </div>
            <div class="row align-items-center my-3">
                <div class="col-12 d-flex flex-wrap align-items-center justify-content-center">
                    <button type="submit" class="btn2 btn-success mt-2 col-6 col-md-3 mx-1">
                        <i class="fas fa-check-circle"></i>&ensp;確認產生新的再評估記錄
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<form method="get" id="Rform" action="@Url.Action("Create")">
    <!--排序用-->
    <!-- Hidden fields -->
    <input type="hidden" id="Start2" name="@(nameof(queryModel.AssessDateStart))" value="@queryModel.AssessDateStart?.ToString("yyyy-MM-dd")" />
    <input type="hidden" id="End2" name="@(nameof(queryModel.AssessDateEnd))" value="@queryModel.AssessDateEnd?.ToString("yyyy-MM-dd")" />
    <input type="hidden" id="@(nameof(queryModel.OrderBy))" name="@(nameof(queryModel.OrderBy))" value="@queryModel.OrderBy" />
    <input type="hidden" id="@(nameof(queryModel.SortDir))" name="@(nameof(queryModel.SortDir))" value="@queryModel.SortDir" />
    <input type="hidden" id="@nameof(queryModel.PageSize)" name="@(nameof(queryModel.PageSize))" value="@queryModel.PageSize" />
</form>

<div class="table">
    <table class="table table-striped table-hover table-bordered text-break" id="myTable">
        <thead>
            <tr>
                @foreach (var item in headers)
                {
                    <th data-id="@item.Key">
                        @if (item.Key != "RowNum")
                        {
                            <a href="#" title="點選「@(item.Value)」欄位進行排序"> @item.Value </a>
                        }
                        else
                        {
                            @item.Value
                        }
                        <span class="order-index"> @(queryModel.OrderBy.EndsWith(item.Key) ? (queryModel.SortDir == "asc" ? "▲" : "▼") : "")</span>
                    </th>
                }
            </tr>
        </thead>
        <tbody>
            @if (!Model.Any())
            {
                <tr>
                    <td colspan="@(headers.Count)">查無資料</td>
                </tr>
            }

            @foreach (var row in Model)
            {
                var keys = row.Keys;
                <tr>
                    @foreach (var key in keys)
                    {
                        string value = TableHelper.FormatValue(row[key]);

                        string cssClass = "";

                        // 品項風險欄位
                        if (key == "RiskLevel")
                        {
                            switch (value)
                            {
                                case "高":
                                    cssClass = "bg-danger text-white";
                                    break;
                                case "中":
                                    cssClass = "bg-warning text-dark";
                                    break;
                                case "低":
                                    cssClass = "bg-success text-white";
                                    break;
                                default:
                                    cssClass = "";
                                    break;
                            }
                        }

                        // 評核結果欄位
                        if (key == "AssessResult")
                        {
                            switch (value)
                            {
                                case "(無)":
                                    cssClass = "none-data";
                                    break;
                                case "不合格":
                                    cssClass = "text-danger";
                                    break;
                                case "連續三年無資料，應移除":
                                    cssClass = "text-primary";
                                    break;
                                case "當年無資料，不評核":
                                    cssClass = "text-success";
                                    break;
                                default:
                                    cssClass = "";
                                    break;
                            }
                        }

                        cssClass = (key == "RowNum") ? "text-nowrap" : cssClass;

                        <td class="@cssClass">
                            @Html.Raw(value)
                        </td>
                    }
                </tr>
            }
        </tbody>
    </table>
</div>

@await Html.PartialAsync("_PagerSection", queryModel)

@section PageScripts {
    <script nonce="@ViewBag.CspNonce">
        $(document).ready(function () {
            tableSortListener("Rform");// 表格排序事件監聽
        });
    </script>
}