@model CustomerFeedbackSystem.Models.Supplier1stAssess
@{
    Layout = "_NoNavWithDetailModalLayout";

    var qualifiedSupplier = new QualifiedSupplier();

    var message = ViewData["FirstAssessMessage"] as string ?? "";

    string alertClass = message.Contains("尚未") ? "alert-warning" : "alert-info";
    string iconClass = message.Contains("尚未") ? "fa-exclamation-triangle" : "fa-info-circle";

}

<div class="m-4">
    <form id="myFormDetail" method="post" action="@Url.Action("Create")">
        @Html.AntiForgeryToken()
        <!-- 供應商資訊 -->
        <h4 class="m-3 px-2"><i class="bi bi-search me-2"></i>供應商基本資料</h4>


        <!-- 供應商基本資料 -->
        <!-- Row A：供應商名稱 / 供應商編號 -->
        <div class="row mb-3 g-3 row-cols-1 row-cols-md-2 align-items-center">

            <!-- 供應商名稱 -->
            <div class="col">
                <div class="row g-2 align-items-center">
                    <label for="@nameof(Model.SupplierName)" class="col-12 col-sm-4 col-form-label text-sm-end text-start">
                        <strong>
                            <span class="text-danger fw-bold">*</span>
                            <span class="text-primary">@Html.DisplayNameFor(m => qualifiedSupplier.SupplierName)</span>：
                        </strong>
                    </label>
                    <div class="col-12 col-sm-8">
                        @* 供應商名稱 datalist *@
                        @await Html.PartialAsync("_PurchaseSupplierNameDataListSelect", Model.SupplierName)
                    </div>
                </div>
            </div>

            <!-- 供應商統編 -->
            <div class="col">
                <div class="row g-2 align-items-center">
                    <label class="col-12 col-sm-4 col-form-label text-sm-end text-start"
                           for="@nameof(qualifiedSupplier.SupplierNo)"
                           data-bs-toggle="tooltip"
                           data-bs-placement="top"
                           data-bs-html="true"
                           data-bs-custom-class="tooltip-left"
                           title="統編為必填，若是院內單位亦請填寫02750963">
                        <strong>
                            <span class="text-danger fw-bold">*</span>@Html.DisplayNameFor(m => qualifiedSupplier.SupplierNo)：
                        </strong>
                    </label>
                    <div class="col-12 col-sm-8">
                        @Html.TextBoxFor(m => qualifiedSupplier.SupplierNo, new { @class = "form-control form-control-narrow", @required = "required" })
                    </div>
                </div>
            </div>
        </div>

        <!-- Row B：供應商類別 / 產品類別 -->
        <div class="row mb-3 g-3 row-cols-1 row-cols-md-2 align-items-center">

            <!-- 供應商類別 (含 tooltip) -->
            <div class="col">
                <div class="row g-2 align-items-center">
                    <label class="col-12 col-sm-4 col-form-label text-sm-end text-start"
                           for="@nameof(Model.SupplierClass)"
                           data-bs-toggle="tooltip"
                           data-bs-placement="top"
                           data-bs-html="true"
                           data-bs-custom-class="tooltip-left"
                           title="<ul><li><b>原料供應商：</b>包括本廠內製程、檢驗相關之原物料和包裝材料。</li><li><b>雜項供應商：</b>包含一般性耗材、實驗與相關檢測用耗材、搬運服務、無塵室清潔、無塵室用品、耗材更換和無塵室設備及水電維修等供應商。</li><li><b>特殊供應商：</b>包含委外滅菌、精密加工、儀器設備採買、校正、動物實驗、無塵室相關環境檢測等供應商。</li><li><b>其他供應商：</b>包含國內外政府機關與醫療器材相關認證、審核之單位。</li></ul>">
                        <strong>
                            <span class="text-danger fw-bold">*</span>@Html.DisplayNameFor(m => qualifiedSupplier.SupplierClass)：
                        </strong>
                    </label>
                    <div class="col-12 col-sm-8">
                        @await Html.PartialAsync("_PurchaseSupplierClassSelect", Model.SupplierClass)
                    </div>
                </div>
            </div>

            <!-- 產品類別 -->
            <div class="col">
                <div class="row g-2 align-items-center">
                    <label class="col-12 col-sm-4 col-form-label text-sm-end text-start" for="@nameof(Model.ProductClass)">
                        <strong>
                            <span class="text-danger fw-bold">*</span>
                            <span class="text-primary">@Html.DisplayNameFor(m => qualifiedSupplier.ProductClass)</span>：
                        </strong>
                    </label>
                    <div class="col-12 col-sm-8">
                        @await Html.PartialAsync("_PurchaseProductClassSelect", Model.ProductClass)
                    </div>
                </div>
            </div>
        </div>

        <!-- Row C：電話 / 電話2 -->
        <div class="row mb-3 g-3 row-cols-1 row-cols-md-2 align-items-center">

            <!-- 電話 -->
            <div class="col">
                <div class="row g-2 align-items-center">
                    <label asp-for="@qualifiedSupplier.Tele" class="col-12 col-sm-4 col-form-label text-sm-end text-start">
                        <strong>
                            <span class="text-danger fw-bold">*</span>@Html.DisplayNameFor(m => qualifiedSupplier.Tele)：
                        </strong>
                    </label>
                    <div class="col-12 col-sm-8">
                        @Html.TextBoxFor(m => qualifiedSupplier.Tele, new { @class = "form-control form-control-narrow", @required = "required" })
                    </div>
                </div>
            </div>

            <!-- 電話2 -->
            <div class="col">
                <div class="row g-2 align-items-center">
                    <label asp-for="@qualifiedSupplier.Tele2" class="col-12 col-sm-4 col-form-label text-sm-end text-start">
                        <strong>
                            @Html.DisplayNameFor(m => qualifiedSupplier.Tele2)：
                        </strong>
                    </label>
                    <div class="col-12 col-sm-8">
                        @Html.TextBoxFor(m => qualifiedSupplier.Tele2, new { @class = "form-control form-control-narrow" })
                    </div>
                </div>
            </div>
        </div>

        <!-- Row D：傳真 / 地址 -->
        <div class="row mb-3 g-3 row-cols-1 row-cols-md-2 align-items-center">

            <!-- 傳真 -->
            <div class="col">
                <div class="row g-2 align-items-center">
                    <label asp-for="@qualifiedSupplier.Fax" class="col-12 col-sm-4 col-form-label text-sm-end text-start">
                        <strong>
                            @Html.DisplayNameFor(m => qualifiedSupplier.Fax)：
                        </strong>
                    </label>
                    <div class="col-12 col-sm-8">
                        @Html.TextBoxFor(m => qualifiedSupplier.Fax, new { @class = "form-control form-control-narrow" })
                    </div>
                </div>
            </div>

            <!-- 地址 -->
            <div class="col">
                <div class="row g-2 align-items-center">
                    <label asp-for="@qualifiedSupplier.Address" class="col-12 col-sm-4 col-form-label text-sm-end text-start">
                        <strong>
                            <span class="text-danger fw-bold">*</span>@Html.DisplayNameFor(m => qualifiedSupplier.Address)：
                        </strong>
                    </label>
                    <div class="col-12 col-sm-8">
                        @Html.TextBoxFor(m => qualifiedSupplier.Address, new { @class = "form-control", @required = "required" })
                    </div>
                </div>
            </div>
        </div>

        <!-- Row E：供應商資訊（單欄佔滿） -->
        <div class="row mb-3 g-3 align-items-center">
            <div class="col">
                <div class="row g-2 align-items-center">
                    <label asp-for="@qualifiedSupplier.SupplierInfo" class="col-12 col-sm-4 col-md-2 col-form-label text-sm-end text-start">
                        <strong>
                            @Html.DisplayNameFor(m => qualifiedSupplier.SupplierInfo)：
                        </strong>
                    </label>
                    <div class="col-12 col-sm-8 col-md-10">
                        @Html.TextBoxFor(m => qualifiedSupplier.SupplierInfo, new { @class = "form-control" })
                    </div>
                </div>
            </div>
        </div>

        <!-- Row F：供應商備註（單欄佔滿） -->
        <div class="row mb-3 g-3 align-items-center">
            <div class="col">
                <div class="row g-2 align-items-center">
                    <label asp-for="@qualifiedSupplier.Remarks" class="col-12 col-sm-4 col-md-2 col-form-label text-sm-end text-start">
                        <strong>
                            @Html.DisplayNameFor(m => qualifiedSupplier.Remarks)：
                        </strong>
                    </label>
                    <div class="col-12 col-sm-8 col-md-10">
                        @Html.TextBoxFor(m => qualifiedSupplier.Remarks, new { @class = "form-control" })
                    </div>
                </div>
            </div>
        </div>

        <!-- Alert 區塊（全寬） -->
        <div id="pageAlert" class="alert d-none alert-dismissible fade" role="alert" aria-live="polite">
            <span class="alert-content"></span>
        </div>

        <!-- 初次評核 -->
        <div class="border-top mt-4 pt-3">
            <h4 class="m-3 px-2"><i class="bi bi-pencil-square me-2"></i>初次評核</h4>

            <!-- Row A：評核人 / 評核日期 -->
            <div class="row mb-3 g-3 row-cols-1 row-cols-md-2 align-items-center">

                <!-- 評核人 -->
                <div class="col">
                    <div class="row g-2 align-items-center">
                        <label class="col-12 col-sm-4 col-form-label text-sm-end text-start" for="@nameof(Model.AssessPeople)">
                            <strong>
                                @Html.DisplayNameFor(m => m.AssessPeople)：
                            </strong>
                        </label>
                        <div class="col-12 col-sm-8">
                            <!-- 因為是新增頁，所以可以寫登入者姓名 -->
                            @User.FindFirst("FullName")?.Value
                        </div>
                    </div>
                </div>

                <!-- 評核日期 -->
                <div class="col">
                    <div class="row g-2 align-items-center">
                        <label class="col-12 col-sm-4 col-form-label text-sm-end text-start" for="@nameof(Model.AssessDate)">
                            <strong>
                                <span class="text-danger fw-bold">*</span>
                                <span class="text-primary">@Html.DisplayNameFor(m => m.AssessDate)</span>：
                            </strong>
                        </label>
                        <div class="col-12 col-sm-8">
                            @Html.TextBoxFor(m => m.AssessDate, new { @class = "form-control form-control-narrow", @required = "required", type = "date", max = DateTime.Today.ToString("yyyy-MM-dd") })
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row B：評核方式 / 評核結果 -->
            <div class="row mb-3 g-3 row-cols-1 row-cols-md-2 align-items-center">

                <!-- 評核方式（Visit + 其他） -->
                <div class="col">
                    <div class="row g-2 align-items-center">
                        <label class="col-12 col-sm-4 col-form-label text-sm-end text-start" for="@nameof(Model.Visit)">
                            <strong>
                                <span class="text-danger fw-bold">*</span>@Html.DisplayNameFor(m => m.Visit)：
                            </strong>
                        </label>
                        <div class="col-12 col-sm-8">
                            <select class="form-select" id="@nameof(Model.Visit)" name="@nameof(Model.Visit)" required>
                                <option value="" disabled selected hidden>請選擇...</option>
                                @foreach (var opt in Supplier1stAssess.VisitOptions)
                                {
                                    <option value="@opt" selected="@(Model.SelectedVisit == opt ? "selected" : null)">@opt</option>
                                }
                            </select>
                            <input type="text"
                                   class="form-control mt-1"
                                   id="@nameof(Model.VisitOther)"
                                   name="@nameof(Model.VisitOther)"
                                   placeholder="其他..."
                                   value="@(Model.SelectedVisit == "其他" ? Model.VisitOther : "")">
                        </div>
                    </div>
                </div>

                <!-- 評核結果（含 tooltip） -->
                <div class="col">
                    <div class="row g-2 align-items-center">
                        <label for="@nameof(Model.AssessResult)"
                               class="col-12 col-sm-4 col-form-label text-sm-end text-start"
                               data-bs-toggle="tooltip"
                               data-bs-placement="top"
                               data-bs-html="true"
                               data-bs-custom-class="tooltip-left"
                               title="若初次供應商之評核不合格，則要求該供應商進行改善後重新評核，需重新填寫「初次供應商評核表(BMP-QP21-TR002)」進行評核，若重新評核後通過需於「改善狀況」欄說明，經行政部主管確認重新評核結果，若重評後仍不合格，則另尋供應商。">
                            <strong>
                                <span class="text-danger fw-bold">*</span>@Html.DisplayNameFor(m => m.AssessResult)：
                            </strong>
                        </label>
                        <div class="col-12 col-sm-8">
                            <select class="form-select" id="@nameof(Model.AssessResult)" name="@nameof(Model.AssessResult)" required>
                                <option value="" disabled selected hidden>請選擇...</option>
                                <option value="合格" selected=@(Model.AssessResult == "合格" ? "selected" : null)>合格</option>
                                <option value="不合格" selected=@(Model.AssessResult == "不合格" ? "selected" : null)>不合格</option>
                                <option value="改善後合格" selected=@(Model.AssessResult == "改善後合格" ? "selected" : null)>改善後合格</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row C：不合格原因 / 改善狀況 -->
            <div class="row mb-3 g-3 row-cols-1 row-cols-md-2 align-items-center">

                <!-- 不合格原因 -->
                <div class="col">
                    <div class="row g-2 align-items-center">
                        <label class="col-12 col-sm-4 col-form-label text-sm-end text-start" for="@nameof(Model.Reason)">
                            <strong>
                                <span class="text-danger fw-bold">*</span>@Html.DisplayNameFor(m => m.Reason)：
                            </strong>
                        </label>
                        <div class="col-12 col-sm-8">
                            <textarea class="form-control" id="@nameof(Model.Reason)" name="@nameof(Model.Reason)" rows="3" placeholder="@Html.DisplayNameFor(m => m.Reason)" required>@Model.Reason</textarea>
                        </div>
                    </div>
                </div>

                <!-- 改善狀況 -->
                <div class="col">
                    <div class="row g-2 align-items-center">
                        <label class="col-12 col-sm-4 col-form-label text-sm-end text-start" for="@nameof(Model.Improvement)">
                            <strong>
                                <span class="text-danger fw-bold">*</span>@Html.DisplayNameFor(m => m.Improvement)：
                            </strong>
                        </label>
                        <div class="col-12 col-sm-8">
                            <input type="text" class="form-control" id="@nameof(Model.Improvement)" name="@nameof(Model.Improvement)" placeholder="@Html.DisplayNameFor(m => m.Improvement)" value="@Model.Improvement">
                            <span id="@nameof(Model.Improvement)PlainText" class="form-text">無須填寫</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row D：風險等級 / 備註1 -->
            <div class="row mb-3 g-3 row-cols-1 row-cols-md-2 align-items-center">

                <!-- 風險等級（含 tooltip） -->
                <div class="col">
                    <div class="row g-2 align-items-center">
                        <label for="@nameof(Model.RiskLevel)"
                               class="col-12 col-sm-4 col-form-label text-sm-end text-start"
                               data-bs-toggle="tooltip"
                               data-bs-placement="top"
                               data-bs-html="true"
                               data-bs-custom-class="tooltip-left"
                               title="<ul><li><b>高風險：</b>供應品對生產環境、製造流程及產品最終品質等具有直接且重大影響。</li><li><b>中風險：</b>對流程與品質有影響但非直接關聯。</li><li><b>低風險：</b>影響輕微或無顯著影響。</li></ul>">
                            <strong>
                                <span class="text-danger fw-bold">*</span>@Html.DisplayNameFor(m => m.RiskLevel)：
                            </strong>
                        </label>
                        <div class="col-12 col-sm-8">
                            <select id="@nameof(Model.RiskLevel)" name="@nameof(Model.RiskLevel)" class="form-select" required>
                                <option value="" selected="@(string.IsNullOrEmpty(Model.RiskLevel) ? "selected" : null)">請選擇</option>
                                @* 新增的時候，風險類型一定要寫 *@
                                @*<option value="N/A" selected="@(Model.RiskLevel == "N/A" ? "selected" : null)">N/A</option>*@
                                <option value="高" selected="@(Model.RiskLevel == "高" ? "selected" : null)">高</option>
                                <option value="中" selected="@(Model.RiskLevel == "中" ? "selected" : null)">中</option>
                                <option value="低" selected="@(Model.RiskLevel == "低" ? "selected" : null)">低</option>
                            </select>
                            <div class="form-text text-muted">N/A 表示舊資料，尚未設定數值</div>
                        </div>
                    </div>
                </div>

                <!-- 備註1 -->
                <div class="col">
                    <div class="row g-2 align-items-center">
                        <label class="col-12 col-sm-4 col-form-label text-sm-end text-start" for="@nameof(Model.Remarks1)">
                            <strong>
                                @Html.DisplayNameFor(m => m.Remarks1)：
                            </strong>
                        </label>
                        <div class="col-12 col-sm-8">
                            <input type="text" class="form-control" id="@nameof(Model.Remarks1)" name="@nameof(Model.Remarks1)" value="@Model.Remarks1">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row E：初供評核編號 / 空 -->
            <div class="row mb-3 g-3 row-cols-1 row-cols-md-2 align-items-center">

                <!-- 初供評核文件編號 -->
                <div class="col">
                    <div class="row g-2 align-items-center">
                        <label for="@nameof(Model.Supplier1stAssessNo)" class="col-12 col-sm-4 col-form-label text-sm-end text-start">
                            <strong>
                                <span class="text-danger fw-bold">*</span>@Html.DisplayNameFor(m => m.Supplier1stAssessNo)：
                            </strong>
                        </label>
                        <div class="col-12 col-sm-8 d-flex align-items-center">
                            <input asp-for="Supplier1stAssessNo" class="form-control" required readonly placeholder="請點選右側「查詢」按鈕" />
                            <a href="@Url.Action("DocSearchModal", "PSupplier1stAssess")"
                               target="_blank"
                               class="docSearch btn btn-outline-secondary"
                               aria-label="開啟初供評核文件編號查詢">
                                <i class="fas fa-search"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- 空 -->
                <div class="col">
                    <div class="row g-2 align-items-center">
                        <div class="col-12 col-sm-12">
                        </div>
                    </div>
                </div>
            </div>



            <!-- 送出按鈕 -->
            <div class="row align-items-center my-3">
                <div class="col-12 d-flex justify-content-center">
                    <button type="submit" class="btn2 btn-success mt-2 col-6 col-md-3 mx-1">
                        <i class="fas fa-check-circle me-1"></i> 評核確認
                    </button>
                </div>
            </div>
    </form>
</div>

@section PageScripts {
    <script nonce="@ViewBag.CspNonce">
        $(document).ready(function() {
            // 初始載入檢查：評估項目
            toggleVisitOther();

            // 綁定事件：評估項目選擇「其他」時，顯示其他空白input
            $("#Visit").on("change", function () {
                toggleVisitOther();
            });

            docSearchBtnDetailModalListener();     // 初供評核文件編號查詢事件監聽

            // 初始載入檢查：評估結果
            toggleImprovement();

            // 綁定事件：評估結果選擇「改善後合格」時，顯示改善狀況空白input
            $("#AssessResult").on("change", toggleImprovement);

            // 供應商datalist選擇後，自動觸發查詢
            $("#SupplierName").on("change", function () {
                const supplierName = $(this).val().trim();
                loadQualifiedSuppliers(supplierName);
            });

        });
    </script>
}