@model CustomerFeedbackSystem.Models.PurchaseRecord
@{
    Layout = "_NoNavWithDetailModalLayout";
    ViewData["Title"] = "電子採購";

    var supplierInfo = ViewData["SupplierInfo"] as QualifiedSupplier ?? new QualifiedSupplier();
}

<div class="m-4">
    <form id="myFormDetail" method="post" action="@Url.Action("Edit", "PAssessment", new { RequestNo = Model.RequestNo })">
        @Html.AntiForgeryToken()

        <h4 class="m-3 px-2"><i class="bi bi-search me-2"></i>請購紀錄</h4>
        <div class="pop">
            @* 請購詳細資料 *@
            @await Html.PartialAsync("_PurchaseDetail", Model)
        </div>

        <hr class="my-4" />

        <h4 class="m-3 px-2"><i class="bi bi-search me-2"></i>驗收紀錄</h4>
        <div class="pop">
            @* 驗收詳細資料 *@
            @await Html.PartialAsync("_PurchaseAssessmentDetail", Model)
        </div>

        <hr class="my-4" />

        <h4 class="m-3 px-2"><i class="bi bi-pencil-square"></i>供應商評核紀錄</h4>
        <div class="pop">
            <!-- 評核日期與品質 -->
            <div class="row align-items-center my-3">
                <div class="col-md-2 col-form-label text-md-end text-start"><strong>@Html.DisplayNameFor(m => m.AssessDate)：</strong></div>
                <div class="col-md-4"><span class="form-control-plaintext">@Html.DisplayFor(m => m.AssessDate)</span></div>
                <label class="col-md-2 col-form-label text-md-end text-start" for="@nameof(Model.QualitySelect)">
                    <span class="text-danger fw-bold">*</span><strong>@Html.DisplayNameFor(m => m.QualitySelect)：</strong>
                </label>
                <div class="col-md-4">
                    <select id="@nameof(Model.QualitySelect)" name="@nameof(Model.QualitySelect)" class="form-select" required>
                        <option disabled selected="@(Model.QualitySelect.HasValue ? null : "selected")">請選擇...</option>
                        <option value="40" selected="@(Model.QualitySelect == 40 ? "selected" : null)">40 - 無問題</option>
                        <option value="10" selected="@(Model.QualitySelect == 10 ? "selected" : null)">10 - 退貨後合格</option>
                        <option value="5" selected="@(Model.QualitySelect == 5 ? "selected" : null)">5 - 不合格可用</option>
                        <option value="0" selected="@(Model.QualitySelect == 0 ? "selected" : null)">0 - 不可用</option>
                    </select>
                </div>
            </div>

            <!-- 價格與規格 -->
            <div class="row align-items-center my-3">
                <label class="col-md-2 col-form-label text-md-end text-start" for="@nameof(Model.PriceSelect)">
                    <span class="text-danger fw-bold">*</span><strong>@Html.DisplayNameFor(m => m.PriceSelect)：</strong>
                </label>
                <div class="col-md-4">
                    <select id="@nameof(Model.PriceSelect)" name="@nameof(Model.PriceSelect)" class="form-select" required>
                        <option disabled selected="@(Model.PriceSelect.HasValue ? null : "selected")">請選擇...</option>
                        <option value="10" selected="@(Model.PriceSelect == 10 ? "selected" : null)">10 - 價格符合預算</option>
                        <option value="5" selected="@(Model.PriceSelect == 5 ? "selected" : null)">5 - 略高於預算</option>
                        <option value="0" selected="@(Model.PriceSelect == 0 ? "selected" : null)">0 - 遠高於預算</option>
                    </select>
                </div>

                <label class="col-md-2 col-form-label text-md-end text-start" for="@nameof(Model.SpecSelect)">
                    <span class="text-danger fw-bold">*</span><strong>@Html.DisplayNameFor(m => m.SpecSelect)：</strong>
                </label>
                <div class="col-md-4">
                    <select id="@nameof(Model.SpecSelect)" name="@nameof(Model.SpecSelect)" class="form-select" required>
                        <option disabled selected="@(Model.SpecSelect.HasValue ? null : "selected")">請選擇...</option>
                        <option value="25" selected="@(Model.SpecSelect == 25 ? "selected" : null)">25 - 完全符合</option>
                        <option value="15" selected="@(Model.SpecSelect == 15 ? "selected" : null)">15 - 稍有差異</option>
                        <option value="0" selected="@(Model.SpecSelect == 0 ? "selected" : null)">0 - 不符規格</option>
                    </select>
                </div>
            </div>

            <!-- 交期與服務 -->
            <div class="row align-items-center my-3">
                <label class="col-md-2 col-form-label text-md-end text-start" for="@nameof(Model.DeliverySelect)">
                    <span class="text-danger fw-bold">*</span><strong>@Html.DisplayNameFor(m => m.DeliverySelect)：</strong>
                </label>
                <div class="col-md-4">
                    <select id="@nameof(Model.DeliverySelect)" name="@nameof(Model.DeliverySelect)" class="form-select" required>
                        <option disabled selected="@(Model.DeliverySelect.HasValue ? null : "selected")">請選擇...</option>
                        <option value="10" selected="@(Model.DeliverySelect == 10 ? "selected" : null)">10 - 準時交貨</option>
                        <option value="0" selected="@(Model.DeliverySelect == 0 ? "selected" : null)">0 - 延遲10天以上</option>
                    </select>
                </div>

                <label class="col-md-2 col-form-label text-md-end text-start" for="@nameof(Model.ServiceSelect)">
                    <span class="text-danger fw-bold">*</span><strong>@Html.DisplayNameFor(m => m.ServiceSelect)：</strong>
                </label>
                <div class="col-md-4">
                    <select id="@nameof(Model.ServiceSelect)" name="@nameof(Model.ServiceSelect)" class="form-select" required>
                        <option disabled selected="@(Model.ServiceSelect.HasValue ? null : "selected")">請選擇...</option>
                        <option value="15" selected="@(Model.ServiceSelect == 15 ? "selected" : null)">15 - 優秀</option>
                        <option value="10" selected="@(Model.ServiceSelect == 10 ? "selected" : null)">10 - 良好</option>
                        <option value="5" selected="@(Model.ServiceSelect == 5 ? "selected" : null)">5 - 差勁</option>
                        <option value="0" selected="@(Model.ServiceSelect == 0 ? "selected" : null)">0 - 無服務</option>
                    </select>
                </div>
            </div>

            <!-- 評核結果與總分 -->
            <div class="row align-items-center my-3">
                <label class="col-md-2 col-form-label text-md-end text-start" for="@nameof(Model.AssessResult)">
                    <span class="text-danger fw-bold">*</span><strong>@Html.DisplayNameFor(m => m.AssessResult)：</strong>
                </label>
                <div class="col-md-4">
                    <select id="@nameof(Model.AssessResult)" name="@nameof(Model.AssessResult)" class="form-select" required>
                        <option disabled selected="@(string.IsNullOrEmpty(Model.AssessResult) ? "selected" : null)">請選擇...</option>
                        <option value="合格" selected="@(Model.AssessResult == "合格" ? "selected" : null)">合格</option>
                        <option value="不合格" selected="@(Model.AssessResult == "不合格" ? "selected" : null)">不合格</option>
                    </select>
                </div>

                <label class="col-md-2 col-form-label text-md-end text-start"><strong>@Html.DisplayNameFor(m => m.Grade)：</strong></label>
                <div class="col-md-4">
                    <input type="text" class="form-control" id="@nameof(Model.Grade)" name="@nameof(Model.Grade)" placeholder="自動加總" disabled />
                </div>
            </div>

            <!-- 供應商評核文件編號 -->
            <div class="row align-items-center my-3">
                <label class="col-md-2 col-form-label text-md-end text-start" for="@nameof(Model.AssessmentNo)">
                    <span class="text-danger fw-bold">*</span><strong>@Html.DisplayNameFor(m => m.AssessmentNo)：</strong>
                </label>
                <div class="col-md-4  d-flex align-items-center">
                    <input asp-for="AssessmentNo" class="form-control" required readonly placeholder="請點選右側「查詢」按鈕" />
                    <a href="@Url.Action("DocSearchModal", "PAssessment")"
                       target="_blank"
                       class="docSearch btn btn-outline-secondary"
                       aria-label="開啟供應商評核文件編號查詢">
                        <i class="fas fa-search"></i>
                    </a>
                </div>
            </div>

            <div class="row align-items-center my-3">
                <div class="col-12 d-flex flex-wrap align-items-center justify-content-center">
                    <button type="submit" class="btn2 btn-success mt-2 col-6 col-md-3 mx-1" id="submitAssessmentBtn">
                        <i class="fas fa-check-circle me-1"></i> 送出/更新評分
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

@section PageScripts {
    <script nonce="@ViewBag.CspNonce">
        $(document).ready(function () {
            updateGradeTotal(); // 初次載入

            docSearchBtnDetailModalListener();     // 供應商評核文件編號查詢事件監聽

            $('#PriceSelect, #SpecSelect, #DeliverySelect, #ServiceSelect, #QualitySelect').on('change', updateGradeTotal);

            $("#myFormDetail").on('submit', function (e) {
                let assessmentNo = $("#AssessmentNo").val();
                if (!checkScore() || assessmentNo=="" || !confirm("是否送出/更新評分?")) {
                    e.preventDefault(); // 取消表單送出
                    alert("請先點選右側查詢按鈕，帶入供應商評核文件編號");
                }
            });

        });
    </script>
}